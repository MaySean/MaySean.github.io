<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>开发环境搭建 | MaySean's Blog</title><meta name="author" content="梅兮昂"><meta name="copyright" content="梅兮昂"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="开发环境搭建基于 docker 搭建 在搭建开发环境之前先创建一个网络，用于容器之间的互相通信  network创建一个网络，用于容器之间的互相通信 1docker network create con-net  查看名为 con-net 的 docker 网络的详细信息 1docker network inspect con-net  nacos1docker run --name nacos">
<meta property="og:type" content="article">
<meta property="og:title" content="开发环境搭建">
<meta property="og:url" content="https://maysean.github.io/dev-env-build/index.html">
<meta property="og:site_name" content="MaySean&#39;s Blog">
<meta property="og:description" content="开发环境搭建基于 docker 搭建 在搭建开发环境之前先创建一个网络，用于容器之间的互相通信  network创建一个网络，用于容器之间的互相通信 1docker network create con-net  查看名为 con-net 的 docker 网络的详细信息 1docker network inspect con-net  nacos1docker run --name nacos">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://maysean.github.io/img/avatar.png">
<meta property="article:published_time" content="2024-08-04T02:47:30.000Z">
<meta property="article:modified_time" content="2024-11-01T02:52:34.472Z">
<meta property="article:author" content="梅兮昂">
<meta property="article:tag" content="maysean">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://maysean.github.io/img/avatar.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://maysean.github.io/dev-env-build/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '开发环境搭建',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-11-01 10:52:34'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/font.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">30</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/bg.png')"><nav id="nav"><span id="blog-info"><a href="/" title="MaySean's Blog"><span class="site-name">MaySean's Blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">开发环境搭建</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-08-04T02:47:30.000Z" title="发表于 2024-08-04 10:47:30">2024-08-04</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-11-01T02:52:34.472Z" title="更新于 2024-11-01 10:52:34">2024-11-01</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">15.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>71分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="开发环境搭建"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="开发环境搭建"><a href="#开发环境搭建" class="headerlink" title="开发环境搭建"></a>开发环境搭建</h1><h2 id="基于-docker-搭建"><a href="#基于-docker-搭建" class="headerlink" title="基于 docker 搭建"></a>基于 docker 搭建</h2><blockquote>
<p>在搭建开发环境之前先创建一个网络，用于容器之间的互相通信</p>
</blockquote>
<h3 id="network"><a href="#network" class="headerlink" title="network"></a>network</h3><p>创建一个网络，用于容器之间的互相通信</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create con-net</span><br></pre></td></tr></table></figure>

<p>查看名为 <code>con-net</code> 的 docker 网络的详细信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network inspect con-net</span><br></pre></td></tr></table></figure>

<h3 id="nacos"><a href="#nacos" class="headerlink" title="nacos"></a>nacos</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name nacos --net con-net -e MODE=standalone -p 8848:8848 -d nacos/nacos-server:2.0.2</span><br></pre></td></tr></table></figure>

<h3 id="mysql-8-0-23"><a href="#mysql-8-0-23" class="headerlink" title="mysql 8.0.23"></a>mysql 8.0.23</h3><p>新增一个 <code>mysql</code> 数据卷，目录可如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/mysql</span><br></pre></td></tr></table></figure>

<p>命令示例（不需要执行）：如果现在我们要运行一个 <code>mysql</code> 的容器，命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run --name mysql \</span><br><span class="line">--net con-net \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">-v /opt/mysql/conf/my.cnf:/etc/mysql/my.cnf \</span><br><span class="line">-v /opt/mysql/data:/var/lib/mysql \  </span><br><span class="line">-v /opt/mysql/logs:/logs \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=root \</span><br><span class="line">-d mysql:8.0.23</span><br></pre></td></tr></table></figure>

<p>命令释义：<code>docker run -v 宿主机目录或文件目录:容器内要挂载的文件目录</code></p>
<blockquote>
<p>注意：运行容器时，如果存在数据卷挂载，最好确保宿主机目录或文件目录存在</p>
</blockquote>
<p>宿主机目录或文件目录与容器内要挂载的文件目录有三个对应关系</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-v /opt/mysql/conf/my.cnf:/etc/mysql/my.cnf</span><br><span class="line">-v /opt/mysql/data:/var/lib/mysql</span><br><span class="line">-v /opt/mysql/logs:/logs</span><br></pre></td></tr></table></figure>

<blockquote>
<p>对于第一个挂载类型为文件挂载，如果宿主机文件目录不存在文件，会运行失败</p>
</blockquote>
<p>对于第一个，我们可以把容器内的文件复制到宿主机上</p>
<p>先运行一个临时容器，不进行数据卷挂载</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run --name mysql \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=root \</span><br><span class="line">-d mysql:8.0.23</span><br></pre></td></tr></table></figure>

<p>使用一下命令把容器内的文件复制到宿主机上</p>
<p>先创建文件目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/mysql/conf</span><br><span class="line">mkdir -p /opt/mysql/data</span><br><span class="line">mkdir -p /opt/mysql/logs</span><br></pre></td></tr></table></figure>

<p>执行复制命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp mysql:/etc/mysql/my.cnf /opt/mysql/conf/my.cnf</span><br></pre></td></tr></table></figure>

<p>vim 修改 my.cnf，在最后一行添加时区配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">default-time-zone=<span class="string">&#x27;+08:00&#x27;</span></span><br></pre></td></tr></table></figure>

<p>修改后的 my.cnf</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">pid-file        = /var/run/mysqld/mysqld.pid</span><br><span class="line">socket          = /var/run/mysqld/mysqld.sock</span><br><span class="line">datadir         = /var/lib/mysql</span><br><span class="line">secure-file-priv= NULL</span><br><span class="line"></span><br><span class="line">!includedir /etc/mysql/conf.d/</span><br><span class="line"></span><br><span class="line">default-time-zone=<span class="string">&#x27;+08:00&#x27;</span></span><br></pre></td></tr></table></figure>

<p>删除运行的临时容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rm -f mysql</span><br></pre></td></tr></table></figure>

<p>运行带容器卷目录挂载的命令</p>
<p><code>--lower-case-table-names=1</code> 此参数为忽略表名大小写配置，只有在首次创建 mysql 容器时有效</p>
<p>如果已经存在库表则需要对库表数据备份，删除 &#x2F;opt&#x2F;mysql&#x2F;data 文件夹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run --name mysql \</span><br><span class="line">--net con-net \</span><br><span class="line">--restart=always \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">-v /opt/mysql/conf/my.cnf:/etc/mysql/my.cnf \</span><br><span class="line">-v /opt/mysql/data:/var/lib/mysql \</span><br><span class="line">-v /opt/mysql/logs:/logs \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=root \</span><br><span class="line">-d mysql:8.0.23 --lower-case-table-names=1</span><br></pre></td></tr></table></figure>

<h3 id="seata-1-7-0"><a href="#seata-1-7-0" class="headerlink" title="seata 1.7.0"></a>seata 1.7.0</h3><p>简单的启动一个 seata</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --net con-net --name seata-server -p 8091:8091 seataio/seata-server:1.7.0</span><br></pre></td></tr></table></figure>

<p>拷贝 seata 容器内部文件到宿主机目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">cp</span> seata-server:/seata-server/resources /opt/seata-server</span><br></pre></td></tr></table></figure>

<p>停止并关闭 seata 服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">rm</span> -f seata-server</span><br></pre></td></tr></table></figure>

<p>使用 <code>tree</code> 命令查看 <code>/opt/seata/resources</code> 目录结构</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tree -L 1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果提示 -bash: tree: 未找到命令，则需要安装；使用 yum install tree 命令安装</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">├── application.example.yml</span><br><span class="line">├── application.yml</span><br><span class="line">├── banner.txt</span><br><span class="line">├── io</span><br><span class="line">├── logback</span><br><span class="line">├── logback-spring.xml</span><br><span class="line">├── lua</span><br><span class="line">├── META-INF</span><br><span class="line">├── README.md</span><br><span class="line">└── README-zh.md</span><br></pre></td></tr></table></figure>

<p>参考 application.example.yml 文件修改后的 application.yml 文件内容</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  Copyright 1999-2019 Seata.io Group.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment">#  you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment">#  You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment">#  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment">#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment">#  See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment">#  limitations under the License.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7091</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">seata-server</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">config:</span> <span class="string">classpath:logback-spring.xml</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">$&#123;user.home&#125;/logs/seata</span></span><br><span class="line">  <span class="attr">extend:</span></span><br><span class="line">    <span class="attr">logstash-appender:</span></span><br><span class="line">      <span class="attr">destination:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:4560</span></span><br><span class="line">    <span class="attr">kafka-appender:</span></span><br><span class="line">      <span class="attr">bootstrap-servers:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9092</span></span><br><span class="line">      <span class="attr">topic:</span> <span class="string">logback_to_logstash</span></span><br><span class="line"></span><br><span class="line"><span class="attr">console:</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">seata</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">seata</span></span><br><span class="line"><span class="attr">seata:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="comment"># support: nacos, consul, apollo, zk, etcd3</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">nacos</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">nacos:8848</span> <span class="comment"># nacos 地址，如果是 seata 和 nacos 在同一网络情况下直接使用 nacos:端口号即可</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">&quot;&quot;</span> <span class="comment"># namespace，默认为空</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">DEFAULT_GROUP</span> <span class="comment"># 分组，默认是 DEFAULT_GROUP</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">nacos</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">nacos</span></span><br><span class="line">      <span class="attr">dataId:</span> <span class="string">seataServer.properties</span> <span class="comment"># 需要在 nacos 添加配置</span></span><br><span class="line">  <span class="attr">registry:</span></span><br><span class="line">    <span class="comment"># support: nacos, eureka, redis, zk, consul, etcd3, sofa</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">nacos</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">nacos:8848</span> <span class="comment"># nacos 地址，如果是 seata 和 nacos 在同一网络情况下直接使用 nacos:端口号即可</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">&quot;&quot;</span> <span class="comment"># namespace，默认为空</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">DEFAULT_GROUP</span> <span class="comment"># 分组，默认是 DEFAULT_GROUP</span></span><br><span class="line">      <span class="attr">cluster:</span> <span class="string">SH</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">nacos</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">nacos</span></span><br><span class="line">      <span class="attr">application:</span> <span class="string">seata-tc-server</span> <span class="comment"># seata 服务名称</span></span><br><span class="line"><span class="comment">#  store:</span></span><br><span class="line">    <span class="comment"># support: file 、 db 、 redis</span></span><br><span class="line"><span class="comment">#    mode: file</span></span><br><span class="line"><span class="comment">#  server:</span></span><br><span class="line"><span class="comment">#    service-port: 8091 #If not configured, the default is &#x27;$&#123;server.port&#125; + 1000&#x27;</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">secretKey:</span> <span class="string">SeataSecretKey0c382ef121d778043159209298fd40bf3850a017</span></span><br><span class="line">    <span class="attr">tokenValidityInMilliseconds:</span> <span class="number">1800000</span></span><br><span class="line">    <span class="attr">ignore:</span></span><br><span class="line">      <span class="attr">urls:</span> <span class="string">/,/**/*.css,/**/*.js,/**/*.html,/**/*.map,/**/*.svg,/**/*.png,/**/*.jpeg,/**/*.ico,/api/v1/auth/login</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：第 47 行 seataServer.properties 的名称要和 nacos 创建的配置名保持一致</p>
</blockquote>
<p>nacos 创建配置 seataServer.properties</p>
<img src="/dev-env-build/image-20231018111220037.png" class="">

<p>seataServer.properties 文件内容</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 数据存储方式，db 代表数据库</span></span><br><span class="line"><span class="attr">store.mode</span>=<span class="string">db</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 数据库配置</span></span><br><span class="line"><span class="attr">store.db.datasource</span>=<span class="string">druid</span></span><br><span class="line"><span class="attr">store.db.dbType</span>=<span class="string">mysql</span></span><br><span class="line"><span class="attr">store.db.driverClassName</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">store.db.url</span>=<span class="string">jdbc:mysql://mysql:3306/seata?useUnicode=true&amp;rewriteBatchedStatements=true</span></span><br><span class="line"><span class="attr">store.db.user</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">store.db.password</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">store.db.minConn</span>=<span class="string">5</span></span><br><span class="line"><span class="attr">store.db.maxConn</span>=<span class="string">30</span></span><br><span class="line"><span class="attr">store.db.globalTable</span>=<span class="string">global_table</span></span><br><span class="line"><span class="attr">store.db.branchTable</span>=<span class="string">branch_table</span></span><br><span class="line"><span class="attr">store.db.queryLimit</span>=<span class="string">100</span></span><br><span class="line"><span class="attr">store.db.lockTable</span>=<span class="string">lock_table</span></span><br><span class="line"><span class="attr">store.db.maxWait</span>=<span class="string">5000</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 事务、日志等配置</span></span><br><span class="line"><span class="attr">server.recovery.committingRetryPeriod</span>=<span class="string">1000</span></span><br><span class="line"><span class="attr">server.recovery.asynCommittingRetryPeriod</span>=<span class="string">1000</span></span><br><span class="line"><span class="attr">server.recovery.rollbackingRetryPeriod</span>=<span class="string">1000</span></span><br><span class="line"><span class="attr">server.recovery.timeoutRetryPeriod</span>=<span class="string">1000</span></span><br><span class="line"><span class="attr">server.maxCommitRetryTimeout</span>=<span class="string">-1</span></span><br><span class="line"><span class="attr">server.maxRollbackRetryTimeout</span>=<span class="string">-1</span></span><br><span class="line"><span class="attr">server.rollbackRetryTimeoutUnlockEnable</span>=<span class="string">false</span></span><br><span class="line"><span class="attr">server.undo.logSaveDays</span>=<span class="string">7</span></span><br><span class="line"><span class="attr">server.undo.logDeletePeriod</span>=<span class="string">86400000</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 客户端与服务端传输方式</span></span><br><span class="line"><span class="attr">transport.serialization</span>=<span class="string">seata</span></span><br><span class="line"><span class="attr">transport.compressor</span>=<span class="string">none</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 关闭 metrics 功能，提高性能</span></span><br><span class="line"><span class="attr">metrics.enabled</span>=<span class="string">false</span></span><br><span class="line"><span class="attr">metrics.registryType</span>=<span class="string">compact</span></span><br><span class="line"><span class="attr">metrics.exporterList</span>=<span class="string">prometheus</span></span><br><span class="line"><span class="attr">metrics.exporterPrometheusPort</span>=<span class="string">9898</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：第 8 行的 mysql:3306 的写法也是因为 seata 和 mysql 在同一 docker 网络下</p>
</blockquote>
<p>mysql 创建数据库表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">-- -------------------------------- The script used when storeMode is &#x27;db&#x27; --------------------------------</span><br><span class="line">-- the table to store GlobalSession data</span><br><span class="line">CREATE TABLE IF NOT EXISTS `global_table`</span><br><span class="line">(</span><br><span class="line">    `xid`                       VARCHAR(128) NOT NULL,</span><br><span class="line">    `transaction_id`            BIGINT,</span><br><span class="line">    `status`                    TINYINT      NOT NULL,</span><br><span class="line">    `application_id`            VARCHAR(32),</span><br><span class="line">    `transaction_service_group` VARCHAR(32),</span><br><span class="line">    `transaction_name`          VARCHAR(128),</span><br><span class="line">    `timeout`                   INT,</span><br><span class="line">    `begin_time`                BIGINT,</span><br><span class="line">    `application_data`          VARCHAR(2000),</span><br><span class="line">    `gmt_create`                DATETIME,</span><br><span class="line">    `gmt_modified`              DATETIME,</span><br><span class="line">    PRIMARY KEY (`xid`),</span><br><span class="line">    KEY `idx_status_gmt_modified` (`status` , `gmt_modified`),</span><br><span class="line">    KEY `idx_transaction_id` (`transaction_id`)</span><br><span class="line">) ENGINE = InnoDB</span><br><span class="line">  DEFAULT CHARSET = utf8mb4;</span><br><span class="line"></span><br><span class="line">-- the table to store BranchSession data</span><br><span class="line">CREATE TABLE IF NOT EXISTS `branch_table`</span><br><span class="line">(</span><br><span class="line">    `branch_id`         BIGINT       NOT NULL,</span><br><span class="line">    `xid`               VARCHAR(128) NOT NULL,</span><br><span class="line">    `transaction_id`    BIGINT,</span><br><span class="line">    `resource_group_id` VARCHAR(32),</span><br><span class="line">    `resource_id`       VARCHAR(256),</span><br><span class="line">    `branch_type`       VARCHAR(8),</span><br><span class="line">    `status`            TINYINT,</span><br><span class="line">    `client_id`         VARCHAR(64),</span><br><span class="line">    `application_data`  VARCHAR(2000),</span><br><span class="line">    `gmt_create`        DATETIME(6),</span><br><span class="line">    `gmt_modified`      DATETIME(6),</span><br><span class="line">    PRIMARY KEY (`branch_id`),</span><br><span class="line">    KEY `idx_xid` (`xid`)</span><br><span class="line">) ENGINE = InnoDB</span><br><span class="line">  DEFAULT CHARSET = utf8mb4;</span><br><span class="line"></span><br><span class="line">-- the table to store lock data</span><br><span class="line">CREATE TABLE IF NOT EXISTS `lock_table`</span><br><span class="line">(</span><br><span class="line">    `row_key`        VARCHAR(128) NOT NULL,</span><br><span class="line">    `xid`            VARCHAR(128),</span><br><span class="line">    `transaction_id` BIGINT,</span><br><span class="line">    `branch_id`      BIGINT       NOT NULL,</span><br><span class="line">    `resource_id`    VARCHAR(256),</span><br><span class="line">    `table_name`     VARCHAR(32),</span><br><span class="line">    `pk`             VARCHAR(36),</span><br><span class="line">    `status`         TINYINT      NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;0:locked ,1:rollbacking&#x27;,</span><br><span class="line">    `gmt_create`     DATETIME,</span><br><span class="line">    `gmt_modified`   DATETIME,</span><br><span class="line">    PRIMARY KEY (`row_key`),</span><br><span class="line">    KEY `idx_status` (`status`),</span><br><span class="line">    KEY `idx_branch_id` (`branch_id`),</span><br><span class="line">    KEY `idx_xid` (`xid`)</span><br><span class="line">) ENGINE = InnoDB</span><br><span class="line">  DEFAULT CHARSET = utf8mb4;</span><br><span class="line"></span><br><span class="line">CREATE TABLE IF NOT EXISTS `distributed_lock`</span><br><span class="line">(</span><br><span class="line">    `lock_key`       CHAR(20) NOT NULL,</span><br><span class="line">    `lock_value`     VARCHAR(20) NOT NULL,</span><br><span class="line">    `expire`         BIGINT,</span><br><span class="line">    primary key (`lock_key`)</span><br><span class="line">) ENGINE = InnoDB</span><br><span class="line">  DEFAULT CHARSET = utf8mb4;</span><br><span class="line"></span><br><span class="line">INSERT INTO `distributed_lock` (lock_key, lock_value, expire) VALUES (&#x27;AsyncCommitting&#x27;, &#x27; &#x27;, 0);</span><br><span class="line">INSERT INTO `distributed_lock` (lock_key, lock_value, expire) VALUES (&#x27;RetryCommitting&#x27;, &#x27; &#x27;, 0);</span><br><span class="line">INSERT INTO `distributed_lock` (lock_key, lock_value, expire) VALUES (&#x27;RetryRollbacking&#x27;, &#x27; &#x27;, 0);</span><br><span class="line">INSERT INTO `distributed_lock` (lock_key, lock_value, expire) VALUES (&#x27;TxTimeoutCheck&#x27;, &#x27; &#x27;, 0);</span><br></pre></td></tr></table></figure>

<p>启动一个 seata</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 不带 UI 端口号</span></span><br><span class="line">docker run -d \</span><br><span class="line">--name seata \</span><br><span class="line">--network=con-net \</span><br><span class="line">-p 8091:8091 \</span><br><span class="line">-e SEATA_IP=192.168.200.128 \</span><br><span class="line">-e SEATA_PORT=8091 \</span><br><span class="line">-v /opt/seata-server:/seata-server/resources \</span><br><span class="line">seataio/seata-server:1.7.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 带 UI 端口号</span></span><br><span class="line">docker run -d \</span><br><span class="line">--name seata \</span><br><span class="line">--network=con-net \</span><br><span class="line">-p 7091:7091 \</span><br><span class="line">-p 8091:8091 \</span><br><span class="line">-e SEATA_IP=192.168.200.128 \</span><br><span class="line">-e SEATA_PORT=8091 \</span><br><span class="line">-v /opt/seata-server:/seata-server/resources \</span><br><span class="line">seataio/seata-server:1.7.0</span><br></pre></td></tr></table></figure>

<ul>
<li>环境变量 <code>SEATA_IP</code> 用于设置 seata 服务的 ip 地址</li>
<li>环境变量 <code>SEATA_PORT</code> 用于设置 seata 服务的端口号，这里设置为 8091</li>
</ul>
<p>可以在 nacos 服务列表中看到 seata 服务</p>
<img src="/dev-env-build/image-20231018111752464.png" class="">

<h3 id="sentinel-1-8-0"><a href="#sentinel-1-8-0" class="headerlink" title="sentinel 1.8.0"></a>sentinel 1.8.0</h3><p>以下是根据你提供的信息，我为你推荐的方法来构建一个 Docker 镜像，以下是步骤：</p>
<ol>
<li><p>创建一个 Dockerfile 文件，主要内容如下：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基于官方的OpenJDK镜像</span></span><br><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>-jre-alpine</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制 sentinel-dashboard-1.8.1.jar 到容器里</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> sentinel-dashboard-1.8.1.jar /app.jar</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行 jar 包</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;java&quot;</span>,<span class="string">&quot;-Dserver.port=8080&quot;</span>,<span class="string">&quot;-Dcsp.sentinel.dashboard.server=localhost:8080&quot;</span>,<span class="string">&quot;-Dproject.name=sentinel-dashboard&quot;</span>,<span class="string">&quot;-jar&quot;</span>,<span class="string">&quot;/app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>将 sentinel-dashboard-1.8.1.jar 文件放在和 Dockerfile 同一个目录下。</p>
</li>
<li><p>在Dockerfile所在目录执行如下命令，构建Docker镜像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t sentinel-dashboard:1.8.1 .</span><br></pre></td></tr></table></figure>

<p>“sentinel-dashboard:1.8.1” 是你想要给你的Docker镜像命名的名字。</p>
</li>
<li><p>运行该Docker镜像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name sentinel --network=con-net -p 8858:8080 sentinel-dashboard:1.8.1</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="redis-6-0"><a href="#redis-6-0" class="headerlink" title="redis 6.0"></a>redis 6.0</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /opt/redis/singleton/data</span><br></pre></td></tr></table></figure>

<p>在 <code>/opt/redis/singleton</code> 目录下新建 <code>redis.conf</code> 文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">bind</span> 0.0.0.0</span><br><span class="line">protected-mode <span class="built_in">yes</span></span><br><span class="line">port 6379</span><br><span class="line">tcp-backlog 511</span><br><span class="line"><span class="built_in">timeout</span> 0</span><br><span class="line">tcp-keepalive 300</span><br><span class="line">daemonize no</span><br><span class="line">supervised no</span><br><span class="line">pidfile /var/run/redis_6379.pid</span><br><span class="line">loglevel notice</span><br><span class="line">logfile <span class="string">&quot;&quot;</span></span><br><span class="line">databases 16</span><br><span class="line">always-show-logo <span class="built_in">yes</span></span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line">stop-writes-on-bgsave-error <span class="built_in">yes</span></span><br><span class="line">rdbcompression <span class="built_in">yes</span></span><br><span class="line">rdbchecksum <span class="built_in">yes</span></span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">rdb-del-sync-files no</span><br><span class="line"><span class="built_in">dir</span> ./</span><br><span class="line">replica-serve-stale-data <span class="built_in">yes</span></span><br><span class="line">replica-read-only <span class="built_in">yes</span></span><br><span class="line">repl-diskless-sync no</span><br><span class="line">repl-diskless-sync-delay 5</span><br><span class="line">repl-diskless-load disabled</span><br><span class="line">repl-disable-tcp-nodelay no</span><br><span class="line">replica-priority 100</span><br><span class="line">acllog-max-len 128</span><br><span class="line">lazyfree-lazy-eviction no</span><br><span class="line">lazyfree-lazy-expire no</span><br><span class="line">lazyfree-lazy-server-del no</span><br><span class="line">replica-lazy-flush no</span><br><span class="line">lazyfree-lazy-user-del no</span><br><span class="line">oom-score-adj no</span><br><span class="line">oom-score-adj-values 0 200 800</span><br><span class="line">appendonly no</span><br><span class="line">appendfilename <span class="string">&quot;appendonly.aof&quot;</span></span><br><span class="line">appendfsync everysec</span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line">aof-load-truncated <span class="built_in">yes</span></span><br><span class="line">aof-use-rdb-preamble <span class="built_in">yes</span></span><br><span class="line">lua-time-limit 5000</span><br><span class="line">slowlog-log-slower-than 10000</span><br><span class="line">slowlog-max-len 128</span><br><span class="line">latency-monitor-threshold 0</span><br><span class="line">notify-keyspace-events <span class="string">&quot;&quot;</span></span><br><span class="line">hash-max-ziplist-entries 512</span><br><span class="line">hash-max-ziplist-value 64</span><br><span class="line">list-max-ziplist-size -2</span><br><span class="line">list-compress-depth 0</span><br><span class="line">set-max-intset-entries 512</span><br><span class="line">zset-max-ziplist-entries 128</span><br><span class="line">zset-max-ziplist-value 64</span><br><span class="line">hll-sparse-max-bytes 3000</span><br><span class="line">stream-node-max-bytes 4096</span><br><span class="line">stream-node-max-entries 100</span><br><span class="line">activerehashing <span class="built_in">yes</span></span><br><span class="line">client-output-buffer-limit normal 0 0 0</span><br><span class="line">client-output-buffer-limit replica 256mb 64mb 60</span><br><span class="line">client-output-buffer-limit pubsub 32mb 8mb 60</span><br><span class="line">hz 10</span><br><span class="line">dynamic-hz <span class="built_in">yes</span></span><br><span class="line">aof-rewrite-incremental-fsync <span class="built_in">yes</span></span><br><span class="line">rdb-save-incremental-fsync <span class="built_in">yes</span></span><br><span class="line">jemalloc-bg-thread <span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置密码为 root</span></span><br><span class="line">requirepass root</span><br></pre></td></tr></table></figure>

<p>运行 redis 容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run \</span><br><span class="line">--net con-net \</span><br><span class="line">-p 6379:6379 \</span><br><span class="line">--name redis \</span><br><span class="line">--privileged=<span class="literal">true</span> \</span><br><span class="line">-v /opt/redis/singleton/redis.conf:/etc/redis/redis.conf \</span><br><span class="line">-v /opt/redis/singleton/data:/data \</span><br><span class="line">-d redis:6.0 \</span><br><span class="line">redis-server /etc/redis/redis.conf</span><br></pre></td></tr></table></figure>



<p>关闭容器后，您可以使用<code>docker run</code>命令并通过<code>-v</code>选项来挂载容器卷目录。假设您已经关闭了名为<code>my-redis</code>的容器，并且想要重新启动它并挂载<code>redisbloom.so</code>文件，您可以按照以下步骤操作：</p>
<p>首先，使用以下命令来重新启动Redis容器并挂载<code>redisbloom.so</code>文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name redis \</span><br><span class="line">-v /opt/redis/singleton/conf/redis.conf:/usr/local/etc/redis/redis.conf \</span><br><span class="line">-v /opt/redis/singleton//redisbloom.so:/usr/local/etc/redis/redisbloom.so \</span><br><span class="line">redis:6.0 redis-server /usr/local/etc/redis/redis.conf --loadmodule /usr/local/etc/redis/redisbloom.so</span><br></pre></td></tr></table></figure>

<p>在上述命令中，<code>./your/redisbloom.so</code>是redisbloom.so文件的实际路径。这将重新启动名为<code>my-redis</code>的容器，并将<code>redisbloom.so</code>文件挂载到容器中。</p>
<p>通过这种方式，您可以重新启动容器并挂载<code>redisbloom.so</code>文件到Redis容器中。希望这能帮助您成功重新挂载<code>redisbloom.so</code>文件到Redis容器中。如果您有任何其他问题或需要更多帮助，请随时告诉我。</p>
<h3 id="elasticsearch-7-6-2"><a href="#elasticsearch-7-6-2" class="headerlink" title="elasticsearch 7.6.2"></a>elasticsearch 7.6.2</h3><p>创建文件目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /opt/elasticsearch/plugins</span><br></pre></td></tr></table></figure>

<p>运行 elasticsearch 7.6.2 容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">--name elasticsearch \</span><br><span class="line">--net con-net \</span><br><span class="line">-e <span class="string">&quot;discovery.type=single-node&quot;</span> \</span><br><span class="line">-e <span class="string">&quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</span> \</span><br><span class="line">-p 9200:9200 -p 9300:9300 \</span><br><span class="line">-v /opt/elasticsearch/plugins:/usr/share/elasticsearch/plugins \</span><br><span class="line">elasticsearch:7.6.2</span><br></pre></td></tr></table></figure>

<p>浏览器进入 <a target="_blank" rel="noopener" href="http://www.maysean.ware:9200/">http://www.maysean.ware:9200</a> 验证 es 是否启动成功</p>
<h4 id="elasticSearch-对象映射"><a href="#elasticSearch-对象映射" class="headerlink" title="elasticSearch 对象映射"></a>elasticSearch 对象映射</h4><h4 id="Field"><a href="#Field" class="headerlink" title="@Field"></a>@Field</h4><p><code>@Field</code> 注解在 Elasticsearch 中用于定义字段的属性，其中包含了多个属性可以设置，包括 <code>name</code>、<code>format</code>、<code>pattern</code>、<code>store</code>、<code>analyzer</code>、<code>searchAnalyzer</code> 和 <code>normalizer</code>。下面是它们的详细解释：</p>
<ol>
<li><code>name</code>：用于指定字段在Elasticsearch中的名称。默认情况下，它将使用Java字段的名称作为Elasticsearch中的字段名称。可以通过设置 <code>name</code> 属性来自定义字段名称。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Field(name = &quot;custom_name&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String myField;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><code>type</code>：指定字段的数据类型。Elasticsearch支持各种数据类型，包括文本、关键字、日期、数字、地理位置等。根据字段的内容和用途，可以选择合适的数据类型。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Field(type = FieldType.Text)</span></span><br><span class="line"><span class="keyword">private</span> String textField;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Field(type = FieldType.Keyword)</span></span><br><span class="line"><span class="keyword">private</span> String keywordField;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Field(type = FieldType.Date)</span></span><br><span class="line"><span class="keyword">private</span> Date dateField;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Field(type = FieldType.Integer)</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> integerField;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Field(type = FieldType.GeoPoint)</span></span><br><span class="line"><span class="keyword">private</span> GeoPoint geoPointField;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><code>format</code>：用于指定日期字段的日期格式。日期字段可以以不同的格式存储在Elasticsearch中，以便进行有效的日期检索和排序。常见的日期格式包括 <code>date_time</code>、<code>epoch_millis</code> 等。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Field(type = FieldType.Date, format = DateFormat.date_time)</span></span><br><span class="line"><span class="keyword">private</span> Date dateField;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li><code>pattern</code>：当 <code>type</code> 设置为 <code>text</code> 时，可以使用 <code>pattern</code> 属性指定字段的分析器。分析器用于将文本分成单词，并将它们存储在倒排索引中以进行搜索。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Field(type = FieldType.Text, analyzer = &quot;standard&quot;, searchAnalyzer = &quot;standard&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String textField;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li><code>store</code>：指定是否将字段的原始值存储在文档中。默认情况下，Elasticsearch仅将字段的索引值存储在倒排索引中，而不存储原始值。可以将 <code>store</code> 属性设置为 <code>true</code> 以存储原始值。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Field(type = FieldType.Keyword, store = true)</span></span><br><span class="line"><span class="keyword">private</span> String keywordField;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li><code>analyzer</code>：指定字段的分析器。分析器定义了如何对文本进行分析，例如如何将文本分成单词、如何过滤停用词等。在索引文档时，会使用指定的分析器处理字段的值。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Field(type = FieldType.Text, analyzer = &quot;standard&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String textField;</span><br></pre></td></tr></table></figure>

<ol start="7">
<li><code>searchAnalyzer</code>：指定在搜索时使用的分析器。默认情况下，搜索使用与索引相同的分析器。但是，有时希望在搜索时使用不同的分析器，可以通过 <code>searchAnalyzer</code> 属性进行设置。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Field(type = FieldType.Text, analyzer = &quot;standard&quot;, searchAnalyzer = &quot;english&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String textField;</span><br></pre></td></tr></table></figure>

<ol start="8">
<li><code>normalizer</code>：用于指定用于字段的正规化器。正规化器类似于分析器，但用于确保在搜索和聚合期间对字段的值进行标准化。通常用于对关键字字段进行精确匹配。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Field(type = FieldType.Keyword, normalizer = &quot;my_normalizer&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String keywordField;</span><br></pre></td></tr></table></figure>

<ol start="9">
<li><code>copyTo</code>：指定一个或多个目标字段的名称，将当前字段的值复制到这些目标字段中，<code>sourceField</code> 的值将会被复制到 <code>copyField</code> 中。这意味着，当你搜索 <code>sourceField</code> 中的内容时，同时也会搜索到 <code>copyField</code> 中的内容。通常情况下，你可以在 <code>copyField</code> 上应用不同的分析器或设置，以满足不同的搜索需求。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Field(type = FieldType.Text, copyTo = &quot;copyField&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String sourceField;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Field(type = FieldType.Text)</span></span><br><span class="line"><span class="keyword">private</span> String copyField;</span><br></pre></td></tr></table></figure>

<h3 id="ik-分词器-7-6-2"><a href="#ik-分词器-7-6-2" class="headerlink" title="ik 分词器 7.6.2"></a>ik 分词器 7.6.2</h3><p>下载地址：<a target="_blank" rel="noopener" href="https://meixiang.lanzoue.com/ihAUd1cp3rrg">https://meixiang.lanzoue.com/ihAUd1cp3rrg</a></p>
<p>将解压后的文件夹放进 <code>/opt/elasticsearch/plugins</code> 目录下，重启 es</p>
<h3 id="kibana-7-6-2"><a href="#kibana-7-6-2" class="headerlink" title="kibana 7.6.2"></a>kibana 7.6.2</h3><p>创建文件目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /opt/kibana/config</span><br></pre></td></tr></table></figure>

<p>进入目录，创建 kibana.yml 文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /opt/kibana/config/kibana.yml</span><br></pre></td></tr></table></figure>

<p>写入以下内容</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ** THIS IS AN AUTO-GENERATED FILE **</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Default Kibana configuration for docker target</span></span><br><span class="line"><span class="attr">server.name:</span> <span class="string">kibana</span></span><br><span class="line"><span class="attr">server.host:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line"><span class="attr">elasticsearch.hosts:</span> [ <span class="string">&quot;http://elasticsearch:9200&quot;</span> ]</span><br><span class="line"><span class="attr">xpack.monitoring.ui.container.elasticsearch.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.reporting.kibanaServer.hostname:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>

<p>运行 kibana 7.6.2 容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">--name kibana \</span><br><span class="line">--net con-net \</span><br><span class="line">-e ELASTICSEARCH_HOSTS=http://elasticsearch:9200 \</span><br><span class="line">-p 5601:5601 \</span><br><span class="line">-v /opt/kibana/config/kibana.yml:/usr/share/kibana/config/kibana.yml \</span><br><span class="line">kibana:7.6.2</span><br></pre></td></tr></table></figure>

<p>浏览器进入 <a target="_blank" rel="noopener" href="http://www.maysean.ware:5601/">http://www.maysean.ware:5601</a> 验证 kibana 是否启动成功</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 查询索引库</span></span><br><span class="line">GET /hotel_index</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 删除索引库</span></span><br><span class="line">DELETE /hotel_index</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 文档查询</span></span><br><span class="line">GET /hotel_index/_doc/36934</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 查询所有文档</span></span><br><span class="line">GET /hotel_index/_search</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 全文检索</span></span><br><span class="line"><span class="comment"># 5.1 单字段查询</span></span><br><span class="line">GET /hotel_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;all&quot;</span>: <span class="string">&quot;外滩如家&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.2 多字段查询，任意一个字段符合条件就算符合查询条件</span></span><br><span class="line">GET /hotel_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;multi_match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;query&quot;</span>: <span class="string">&quot;外滩如家&quot;</span>,</span><br><span class="line">      <span class="string">&quot;fields&quot;</span>: [<span class="string">&quot;brand&quot;</span>, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;business&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 精准查询</span></span><br><span class="line"><span class="comment"># 6.1 term 查询，查询的条件也必须是 不分词 的词条</span></span><br><span class="line"><span class="comment"># 6.1.1 city 的 type 是 keyword，不参与分词</span></span><br><span class="line">GET /hotel_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;city&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;上海&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 6.1.2 city 的 type 是 keyword，不参与分词，如果是多个词语组成的短语时，反而搜索不到</span></span><br><span class="line">GET /hotel_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;city&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;杭州上海&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6.2 range 查询，范围查询</span></span><br><span class="line"><span class="comment"># 6.2.1 gte 表示大于等于，gt 表示大于；lte 表示小于等于，lt 表示小于</span></span><br><span class="line"><span class="comment"># 6.2.2 此处检索的是 1000 &lt;= price &lt;= 3000 的酒店信息</span></span><br><span class="line">GET /hotel_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;price&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;gte&quot;</span>: 1000,</span><br><span class="line">        <span class="string">&quot;lte&quot;</span>: 3000</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. 地理坐标查询</span></span><br><span class="line"><span class="comment"># 7.1 附近查询，也叫做距离查询（geo_distance）：查询到指定中心点小于某个距离值</span></span><br><span class="line"><span class="comment"># 7.1.1 搜索陆家嘴附近 15km 的酒店</span></span><br><span class="line">GET /hotel_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;geo_distance&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;distance&quot;</span>: <span class="string">&quot;15km&quot;</span>,</span><br><span class="line">      <span class="string">&quot;location&quot;</span>: <span class="string">&quot;31.21, 121.5&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7.1.2 搜索陆家嘴附近 3km 的酒店</span></span><br><span class="line">GET /hotel_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;geo_distance&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;distance&quot;</span>: <span class="string">&quot;3km&quot;</span>,</span><br><span class="line">      <span class="string">&quot;location&quot;</span>: <span class="string">&quot;31.21, 121.5&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 8. 复合查询</span></span><br><span class="line"><span class="comment"># 8.1 算分函数查询</span></span><br><span class="line"><span class="comment"># 8.1.1 原始查询</span></span><br><span class="line">GET /hotel_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;function_score&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;all&quot;</span>: <span class="string">&quot;外滩&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 8.1.2 添加算分函数，如家得分就提升了</span></span><br><span class="line">GET /hotel_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;function_score&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;all&quot;</span>: <span class="string">&quot;外滩&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;functions&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;brand&quot;</span>: <span class="string">&quot;如家&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&quot;weight&quot;</span>: 10</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;boost_mode&quot;</span>: <span class="string">&quot;sum&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 9. 布尔查询</span></span><br><span class="line"><span class="comment"># 9.1 需求：搜索名字包含&quot;如家&quot;，价格高于 400，在坐标 (31.21, 121.5) 周围 10km 范围内的酒店</span></span><br><span class="line">GET /hotel_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;must&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;如家&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;must_not&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;price&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;gt&quot;</span>: 400</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;filter&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;geo_distance&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;distance&quot;</span>: <span class="string">&quot;10km&quot;</span>,</span><br><span class="line">            <span class="string">&quot;location&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;lat&quot;</span>: 31.21,</span><br><span class="line">              <span class="string">&quot;lon&quot;</span>: 121.5</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 10 排序</span></span><br><span class="line"><span class="comment"># 10.1 普通字段排序</span></span><br><span class="line"><span class="comment"># 10.1.1 需求描述：酒店数据按照用户评分（socer）降序排序，评价相同的按照价格（price）升序排序</span></span><br><span class="line">GET /hotel_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;score&quot;</span>: <span class="string">&quot;desc&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;price&quot;</span>: <span class="string">&quot;asc&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 10.2 地理坐标排序</span></span><br><span class="line"><span class="comment"># 10.2.1 需求描述：实现对酒店数据按照你的位置坐标的距离升序排序</span></span><br><span class="line"><span class="comment"># 假设我的位置是：(31.034661, 121.612282)，寻找我周围最近的酒店</span></span><br><span class="line">GET /hotel_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;_geo_distance&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;location&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;lat&quot;</span>: 31.034661,</span><br><span class="line">          <span class="string">&quot;lon&quot;</span>: 121.612282</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;order&quot;</span>: <span class="string">&quot;asc&quot;</span>,</span><br><span class="line">        <span class="string">&quot;unit&quot;</span>: <span class="string">&quot;km&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 11. 分页查询</span></span><br><span class="line"><span class="comment"># 11.1 基本的分页</span></span><br><span class="line"><span class="comment"># from 分页开始的位置，默认为 0</span></span><br><span class="line"><span class="comment"># size 期望获取的文档总数</span></span><br><span class="line">GET /hotel_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;from&quot;</span>: 0,</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 5,</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;price&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;order&quot;</span>: <span class="string">&quot;asc&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>






<h3 id="minio"><a href="#minio" class="headerlink" title="minio"></a>minio</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://min.io/docs/minio/container/index.html">MinIO Object Storage for Container — MinIO Object Storage for Container</a></p>
</blockquote>
<p>这是一个 Docker 命令，用来启动 MinIO 服务器。主要参数如下：</p>
<ul>
<li><code>-d</code>：以后台模式运行容器</li>
<li><code>--net con-net</code>：加入到网络con-net</li>
<li><code>-p 9000:9000</code> 和 <code>-p 9090:9090</code>：映射容器的9000和9090端口到宿主机的相应端口</li>
<li><code>--name minio</code>：给容器命名为minio</li>
<li><code>-v /opt/minio/data:/minio/data</code>：将宿主机的&#x2F;opt&#x2F;minio&#x2F;data 目录挂载到容器的 &#x2F;minio&#x2F;data 目录下</li>
<li><code>-e &quot;MINIO_ROOT_USER=maysean&quot;</code> 和 <code>-e &quot;MINIO_ROOT_PASSWORD=630CYx5LjjuqGBrV&quot;</code>：设置MinIO服务器的根用户和密码</li>
<li><code>minio/minio server /minio/data --console-address &quot;:9090&quot;</code>：启动 MinIO 服务器，服务器的数据存储在 &#x2F;minio&#x2F;data 目录下，控制台地址设置为 9090 端口。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">--net con-net \</span><br><span class="line">-p 9000:9000 \</span><br><span class="line">-p 9090:9090 \</span><br><span class="line">--name minio \</span><br><span class="line">-v /opt/minio/data:/minio/data \</span><br><span class="line">-e <span class="string">&quot;MINIO_ROOT_USER=maysean&quot;</span> \</span><br><span class="line">-e <span class="string">&quot;MINIO_ROOT_PASSWORD=630CYx5LjjuqGBrV&quot;</span> \</span><br><span class="line">minio/minio server /minio/data --console-address <span class="string">&quot;:9090&quot;</span></span><br></pre></td></tr></table></figure>

<img src="/dev-env-build/image-20240310211005079.png" class="" title="image-20240310211005079">

<img src="/dev-env-build/image-20240310210931563.png" class="" title="image-20240310210931563">

<h3 id="GCC"><a href="#GCC" class="headerlink" title="GCC"></a>GCC</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install gcc</span><br></pre></td></tr></table></figure>

<h3 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h3><p>创建一个临时的 nginx 容器用于容器目录拷贝</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name nginx -d nginx</span><br></pre></td></tr></table></figure>

<p>拷贝 html 和 配置文件目录</p>
<blockquote>
<p>文件拷贝的时候，宿主机路径要到文件，而目录拷贝的时候，到宿主机目录上层即可</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /opt/nginx/conf</span><br><span class="line">docker <span class="built_in">cp</span> nginx:/etc/nginx/nginx.conf /opt/nginx/conf/nginx.conf</span><br><span class="line">docker <span class="built_in">cp</span> nginx:/usr/share/nginx/html /opt/nginx</span><br></pre></td></tr></table></figure>

<p>删除临时容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">rm</span> -f nginx</span><br></pre></td></tr></table></figure>

<p>创建 nginx 容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run --name nginx \</span><br><span class="line">--net con-net \</span><br><span class="line">-p 8080:80 \</span><br><span class="line">-v /opt/nginx/conf/nginx.conf:/etc/nginx/nginx.conf \</span><br><span class="line">-v /opt/nginx/html:/usr/share/nginx/html \</span><br><span class="line">-d nginx:latest</span><br></pre></td></tr></table></figure>

<p>挂载自定义配置文件（如黑马程序猿黑马头条）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run --name nginx-hm \</span><br><span class="line">--net con-net \</span><br><span class="line">-p 8801:8801 \</span><br><span class="line">-v /opt/nginx/conf/nginx.conf:/etc/nginx/nginx.conf \</span><br><span class="line">-v /opt/nginx/conf/leadnews.conf:/etc/nginx/leadnews.conf \</span><br><span class="line">-v /opt/nginx/html:/usr/share/nginx/html \</span><br><span class="line">-d nginx:latest</span><br></pre></td></tr></table></figure>

<h4 id="安装编辑器（如果未安装）"><a href="#安装编辑器（如果未安装）" class="headerlink" title="安装编辑器（如果未安装）"></a>安装编辑器（如果未安装）</h4><p>如果进入容器后发现没有安装任何编辑器，可以先安装一个。以下是安装 <code>vim</code> 或 <code>nano</code> 的方法，具体取决于容器的基础操作系统。</p>
<p>可以执行这个命令查看容器是基于哪个操作系统构建的</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/os-release</span><br></pre></td></tr></table></figure>

<p>基于 debian&#x2F;ubuntu 的镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br><span class="line"></span><br><span class="line">apt-get install vim -y</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">apt-get install nano -y</span><br></pre></td></tr></table></figure>

<p>基于 alpine 的镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apk update</span><br><span class="line">apk add vim</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">apk add nano</span><br></pre></td></tr></table></figure>

<p>基于 centos&#x2F;rhel 的镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install vim -y</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">yum install nano -y</span><br></pre></td></tr></table></figure>

<h3 id="xxljob"><a href="#xxljob" class="headerlink" title="xxljob"></a>xxljob</h3><p>初始化 xxljob 数据库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"># XXL-JOB v2.3.0</span><br><span class="line"># Copyright (c) 2015-present, xuxueli.</span><br><span class="line"></span><br><span class="line">CREATE database if NOT EXISTS `xxl_job` default character set utf8mb4 collate utf8mb4_unicode_ci;</span><br><span class="line">use `xxl_job`;</span><br><span class="line"></span><br><span class="line">SET NAMES utf8mb4;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `xxl_job_info` (</span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `job_group` int(11) NOT NULL COMMENT &#x27;执行器主键ID&#x27;,</span><br><span class="line">  `job_desc` varchar(255) NOT NULL,</span><br><span class="line">  `add_time` datetime DEFAULT NULL,</span><br><span class="line">  `update_time` datetime DEFAULT NULL,</span><br><span class="line">  `author` varchar(64) DEFAULT NULL COMMENT &#x27;作者&#x27;,</span><br><span class="line">  `alarm_email` varchar(255) DEFAULT NULL COMMENT &#x27;报警邮件&#x27;,</span><br><span class="line">  `schedule_type` varchar(50) NOT NULL DEFAULT &#x27;NONE&#x27; COMMENT &#x27;调度类型&#x27;,</span><br><span class="line">  `schedule_conf` varchar(128) DEFAULT NULL COMMENT &#x27;调度配置，值含义取决于调度类型&#x27;,</span><br><span class="line">  `misfire_strategy` varchar(50) NOT NULL DEFAULT &#x27;DO_NOTHING&#x27; COMMENT &#x27;调度过期策略&#x27;,</span><br><span class="line">  `executor_route_strategy` varchar(50) DEFAULT NULL COMMENT &#x27;执行器路由策略&#x27;,</span><br><span class="line">  `executor_handler` varchar(255) DEFAULT NULL COMMENT &#x27;执行器任务handler&#x27;,</span><br><span class="line">  `executor_param` varchar(512) DEFAULT NULL COMMENT &#x27;执行器任务参数&#x27;,</span><br><span class="line">  `executor_block_strategy` varchar(50) DEFAULT NULL COMMENT &#x27;阻塞处理策略&#x27;,</span><br><span class="line">  `executor_timeout` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;任务执行超时时间，单位秒&#x27;,</span><br><span class="line">  `executor_fail_retry_count` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;失败重试次数&#x27;,</span><br><span class="line">  `glue_type` varchar(50) NOT NULL COMMENT &#x27;GLUE类型&#x27;,</span><br><span class="line">  `glue_source` mediumtext COMMENT &#x27;GLUE源代码&#x27;,</span><br><span class="line">  `glue_remark` varchar(128) DEFAULT NULL COMMENT &#x27;GLUE备注&#x27;,</span><br><span class="line">  `glue_updatetime` datetime DEFAULT NULL COMMENT &#x27;GLUE更新时间&#x27;,</span><br><span class="line">  `child_jobid` varchar(255) DEFAULT NULL COMMENT &#x27;子任务ID，多个逗号分隔&#x27;,</span><br><span class="line">  `trigger_status` tinyint(4) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;调度状态：0-停止，1-运行&#x27;,</span><br><span class="line">  `trigger_last_time` bigint(13) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;上次调度时间&#x27;,</span><br><span class="line">  `trigger_next_time` bigint(13) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;下次调度时间&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `xxl_job_log` (</span><br><span class="line">  `id` bigint(20) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `job_group` int(11) NOT NULL COMMENT &#x27;执行器主键ID&#x27;,</span><br><span class="line">  `job_id` int(11) NOT NULL COMMENT &#x27;任务，主键ID&#x27;,</span><br><span class="line">  `executor_address` varchar(255) DEFAULT NULL COMMENT &#x27;执行器地址，本次执行的地址&#x27;,</span><br><span class="line">  `executor_handler` varchar(255) DEFAULT NULL COMMENT &#x27;执行器任务handler&#x27;,</span><br><span class="line">  `executor_param` varchar(512) DEFAULT NULL COMMENT &#x27;执行器任务参数&#x27;,</span><br><span class="line">  `executor_sharding_param` varchar(20) DEFAULT NULL COMMENT &#x27;执行器任务分片参数，格式如 1/2&#x27;,</span><br><span class="line">  `executor_fail_retry_count` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;失败重试次数&#x27;,</span><br><span class="line">  `trigger_time` datetime DEFAULT NULL COMMENT &#x27;调度-时间&#x27;,</span><br><span class="line">  `trigger_code` int(11) NOT NULL COMMENT &#x27;调度-结果&#x27;,</span><br><span class="line">  `trigger_msg` text COMMENT &#x27;调度-日志&#x27;,</span><br><span class="line">  `handle_time` datetime DEFAULT NULL COMMENT &#x27;执行-时间&#x27;,</span><br><span class="line">  `handle_code` int(11) NOT NULL COMMENT &#x27;执行-状态&#x27;,</span><br><span class="line">  `handle_msg` text COMMENT &#x27;执行-日志&#x27;,</span><br><span class="line">  `alarm_status` tinyint(4) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;告警状态：0-默认、1-无需告警、2-告警成功、3-告警失败&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  KEY `I_trigger_time` (`trigger_time`),</span><br><span class="line">  KEY `I_handle_code` (`handle_code`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `xxl_job_log_report` (</span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `trigger_day` datetime DEFAULT NULL COMMENT &#x27;调度-时间&#x27;,</span><br><span class="line">  `running_count` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;运行中-日志数量&#x27;,</span><br><span class="line">  `suc_count` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;执行成功-日志数量&#x27;,</span><br><span class="line">  `fail_count` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;执行失败-日志数量&#x27;,</span><br><span class="line">  `update_time` datetime DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `i_trigger_day` (`trigger_day`) USING BTREE</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `xxl_job_logglue` (</span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `job_id` int(11) NOT NULL COMMENT &#x27;任务，主键ID&#x27;,</span><br><span class="line">  `glue_type` varchar(50) DEFAULT NULL COMMENT &#x27;GLUE类型&#x27;,</span><br><span class="line">  `glue_source` mediumtext COMMENT &#x27;GLUE源代码&#x27;,</span><br><span class="line">  `glue_remark` varchar(128) NOT NULL COMMENT &#x27;GLUE备注&#x27;,</span><br><span class="line">  `add_time` datetime DEFAULT NULL,</span><br><span class="line">  `update_time` datetime DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `xxl_job_registry` (</span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `registry_group` varchar(50) NOT NULL,</span><br><span class="line">  `registry_key` varchar(255) NOT NULL,</span><br><span class="line">  `registry_value` varchar(255) NOT NULL,</span><br><span class="line">  `update_time` datetime DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  KEY `i_g_k_v` (`registry_group`,`registry_key`,`registry_value`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `xxl_job_group` (</span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `app_name` varchar(64) NOT NULL COMMENT &#x27;执行器AppName&#x27;,</span><br><span class="line">  `title` varchar(12) NOT NULL COMMENT &#x27;执行器名称&#x27;,</span><br><span class="line">  `address_type` tinyint(4) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;执行器地址类型：0=自动注册、1=手动录入&#x27;,</span><br><span class="line">  `address_list` text COMMENT &#x27;执行器地址列表，多地址逗号分隔&#x27;,</span><br><span class="line">  `update_time` datetime DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `xxl_job_user` (</span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `username` varchar(50) NOT NULL COMMENT &#x27;账号&#x27;,</span><br><span class="line">  `password` varchar(50) NOT NULL COMMENT &#x27;密码&#x27;,</span><br><span class="line">  `role` tinyint(4) NOT NULL COMMENT &#x27;角色：0-普通用户、1-管理员&#x27;,</span><br><span class="line">  `permission` varchar(255) DEFAULT NULL COMMENT &#x27;权限：执行器ID列表，多个逗号分割&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `i_username` (`username`) USING BTREE</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `xxl_job_lock` (</span><br><span class="line">  `lock_name` varchar(50) NOT NULL COMMENT &#x27;锁名称&#x27;,</span><br><span class="line">  PRIMARY KEY (`lock_name`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br><span class="line"></span><br><span class="line">INSERT INTO `xxl_job_group`(`id`, `app_name`, `title`, `address_type`, `address_list`, `update_time`) VALUES (1, &#x27;xxl-job-executor-sample&#x27;, &#x27;示例执行器&#x27;, 0, NULL, &#x27;2018-11-03 22:21:31&#x27; );</span><br><span class="line">INSERT INTO `xxl_job_info`(`id`, `job_group`, `job_desc`, `add_time`, `update_time`, `author`, `alarm_email`, `schedule_type`, `schedule_conf`, `misfire_strategy`, `executor_route_strategy`, `executor_handler`, `executor_param`, `executor_block_strategy`, `executor_timeout`, `executor_fail_retry_count`, `glue_type`, `glue_source`, `glue_remark`, `glue_updatetime`, `child_jobid`) VALUES (1, 1, &#x27;测试任务1&#x27;, &#x27;2018-11-03 22:21:31&#x27;, &#x27;2018-11-03 22:21:31&#x27;, &#x27;XXL&#x27;, &#x27;&#x27;, &#x27;CRON&#x27;, &#x27;0 0 0 * * ? *&#x27;, &#x27;DO_NOTHING&#x27;, &#x27;FIRST&#x27;, &#x27;demoJobHandler&#x27;, &#x27;&#x27;, &#x27;SERIAL_EXECUTION&#x27;, 0, 0, &#x27;BEAN&#x27;, &#x27;&#x27;, &#x27;GLUE代码初始化&#x27;, &#x27;2018-11-03 22:21:31&#x27;, &#x27;&#x27;);</span><br><span class="line">INSERT INTO `xxl_job_user`(`id`, `username`, `password`, `role`, `permission`) VALUES (1, &#x27;admin&#x27;, &#x27;e10adc3949ba59abbe56e057f20f883e&#x27;, 1, NULL);</span><br><span class="line">INSERT INTO `xxl_job_lock` ( `lock_name`) VALUES ( &#x27;schedule_lock&#x27;);</span><br><span class="line"></span><br><span class="line">commit;</span><br></pre></td></tr></table></figure>

<p>运行 xxljob 容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -e PARAMS=<span class="string">&quot;--spring.datasource.url=jdbc:mysql://mysql:3306/xxl_job?Unicode=true&amp;characterEncoding=UTF-8 \</span></span><br><span class="line"><span class="string">--spring.datasource.username=root \</span></span><br><span class="line"><span class="string">--spring.datasource.password=root&quot;</span> \</span><br><span class="line">--name xxl-job-admin \</span><br><span class="line">--net con-net \</span><br><span class="line">-v /opt/xxljob/applogs:/data/applogs \</span><br><span class="line">-p 8888:8080 \</span><br><span class="line">xuxueli/xxl-job-admin:2.3.0</span><br></pre></td></tr></table></figure>

<p>访问地址：<a target="_blank" rel="noopener" href="http://www.maysean.ware:8888/xxl-job-admin">http://www.maysean.ware:8888/xxl-job-admin</a></p>
<p>默认账号：admin</p>
<p>默认密码：123456</p>
<h3 id="rabbitmq"><a href="#rabbitmq" class="headerlink" title="rabbitmq"></a>rabbitmq</h3><p>拉取 rabbitmq 镜像，最好拉取带 <code>-management</code> 结尾的版本，能省去很多麻烦</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull rabbitmq:3.8-management</span><br></pre></td></tr></table></figure>

<p>创建 rabbitmq 容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">--name rabbitmq \</span><br><span class="line">--network con-net \</span><br><span class="line">-p 5672:5672 \</span><br><span class="line">-p 15672:15672 \</span><br><span class="line">-e RABBITMQ_DEFAULT_USER=maysean \</span><br><span class="line">-e RABBITMQ_DEFAULT_PASS=maysean \</span><br><span class="line">-v plugins:/plugins \</span><br><span class="line">rabbitmq:3.8-management</span><br></pre></td></tr></table></figure>

<blockquote>
<p>-v plugins:&#x2F;plugins 此处没有指定宿主机目录，而是创建了一个名为 plugins 的容器卷</p>
</blockquote>
<p>rabbitmq 访问地址：<a target="_blank" rel="noopener" href="http://www.maysean.ware:15672/">http://www.maysean.ware:15672</a></p>
<h3 id="插件挂载"><a href="#插件挂载" class="headerlink" title="插件挂载"></a>插件挂载</h3><p>执行命令 <code>↓</code> 得到插件 <code>plugins</code> 挂载的路径</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect -f <span class="string">&#x27;&#123;&#123;range .Mounts&#125;&#125;&#123;&#123;if eq .Name &quot;plugins&quot;&#125;&#125;&#123;&#123;.Source&#125;&#125;&#123;&#123;end&#125;&#125;&#123;&#123;end&#125;&#125;&#x27;</span> rabbitmq</span><br></pre></td></tr></table></figure>

<p>将需要装的插件上传到这个目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/var/lib/docker/volumes/plugins/_data</span><br></pre></td></tr></table></figure>

<p>例如：需要挂载延迟队列插件，点击下面链接进行下载</p>
<p><a target="_blank" rel="noopener" href="https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases/download/v3.8.0/rabbitmq_delayed_message_exchange-3.8.0.ez">https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases/download/v3.8.0/rabbitmq_delayed_message_exchange-3.8.0.ez</a></p>
<p>上传完成后，执行命令 <code>↓</code> 开启延迟队列插件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it rabbitmq rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_delayed_message_exchange</span><br></pre></td></tr></table></figure>

<h3 id="kafka"><a href="#kafka" class="headerlink" title="kafka"></a>kafka</h3><p>Kafka 对于 zookeeper 是强依赖，保存 kafka 相关的节点数据，所以安装 Kafka 之前必须先安装zookeeper</p>
<p>拉取 zookeeper 镜像</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull zookeeper:3.4.14</span><br></pre></td></tr></table></figure>

<p>创建 zookeeper 容器 </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">--name zookeeper \</span><br><span class="line">--network con-net \</span><br><span class="line">-v /etc/localtime:/etc/localtime \</span><br><span class="line">-p 2181:2181 \</span><br><span class="line">zookeeper:3.4.14</span><br></pre></td></tr></table></figure>

<p>拉取 kafka 镜像</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull wurstmeister/kafka:2.12-2.4.1</span><br></pre></td></tr></table></figure>

<p>创建 kafka 容器 </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">--name kafka \</span><br><span class="line">--network con-net \</span><br><span class="line">-p 9092:9092 \</span><br><span class="line">-e KAFKA_ADVERTISED_HOST_NAME=192.168.200.128 \</span><br><span class="line">-e KAFKA_ZOOKEEPER_CONNECT=zookeeper \</span><br><span class="line">-e KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://192.168.200.128:9092 \</span><br><span class="line">-e KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092 \</span><br><span class="line">-e KAFKA_HEAP_OPTS=<span class="string">&quot;-Xmx256M -Xms256M&quot;</span> \</span><br><span class="line">wurstmeister/kafka:2.12-2.4.1</span><br></pre></td></tr></table></figure>

<h3 id="MongoDB"><a href="#MongoDB" class="headerlink" title="MongoDB"></a>MongoDB</h3><p>创建容器挂载目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /opt/mongo/data</span><br></pre></td></tr></table></figure>

<p>运行容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -<span class="built_in">id</span> \</span><br><span class="line">--name mongo \</span><br><span class="line">--network con-net \</span><br><span class="line">-v /opt/mongo/data:/data/db \</span><br><span class="line">-p 27017:27017 \</span><br><span class="line">mongo:4.4.10</span><br></pre></td></tr></table></figure>







<h2 id="原生方式搭建"><a href="#原生方式搭建" class="headerlink" title="原生方式搭建"></a>原生方式搭建</h2><h3 id="jdk"><a href="#jdk" class="headerlink" title="jdk"></a>jdk</h3><h4 id="openjdk"><a href="#openjdk" class="headerlink" title="openjdk"></a>openjdk</h4><p>运行以下命令更新所有的包</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum update</span><br></pre></td></tr></table></figure>

<p>安装 OpenJDK，您可以选择安装 JDK 8 或者更高的版本。例如，要安装 JDK 8，使用以下命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install java-1.8.0-openjdk -y</span><br></pre></td></tr></table></figure>

<p>确认安装并查看安装的版本：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -version</span><br></pre></td></tr></table></figure>

<h4 id="oraclejdk"><a href="#oraclejdk" class="headerlink" title="oraclejdk"></a>oraclejdk</h4><p>下载 <code>jdk-8u311-linux-x64.tar.gz</code> 文件。如果还没有下载，可以从 <a target="_blank" rel="noopener" href="https://www.oracle.com/java/technologies/javase/javase-jdk8-downloads.html">Oracle 官方网站</a> 下载；将下载的 tar.gz 文件解压到你想要安装 JDK 的目录。假设你将文件下载到 <code>/opt</code> 目录下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt</span><br><span class="line">sudo tar -zxvf jdk-8u311-linux-x64.tar.gz</span><br></pre></td></tr></table></figure>

<p>解压完成后，需要配置环境变量以便系统识别 JDK。编辑 <code>/etc/profile</code> 文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/profile</span><br></pre></td></tr></table></figure>

<p>在文件末尾添加以下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> JAVA_HOME=/opt/jdk1.8.0_311</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>

<p>执行以下命令使环境变量立即生效：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>

<p>最后，验证 JDK 是否安装成功：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -version</span><br></pre></td></tr></table></figure>

<p>如果安装成功，你应该会看到类似以下的输出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java version <span class="string">&quot;1.8.0_311&quot;</span></span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_311-b11)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.311-b11, mixed mode)</span><br></pre></td></tr></table></figure>

<h3 id="zookeeper"><a href="#zookeeper" class="headerlink" title="zookeeper"></a>zookeeper</h3><blockquote>
<p>在 zookeeper 安装之前确保已经安装了 jdk</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看 jdk 版本</span></span><br><span class="line">java -version</span><br></pre></td></tr></table></figure>

<p>蓝奏云：<a target="_blank" rel="noopener" href="https://meixiang.lanzouw.com/ifWI51zvh25c">zookeeper_3.5.6.tar.gz</a></p>
<h4 id="单机部署"><a href="#单机部署" class="headerlink" title="单机部署"></a>单机部署</h4><ol>
<li>将 tar 包上传到 <code>/opt</code> 目录下，切换目录到 <code>/opt</code> 执行解压</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /opt</span><br><span class="line"></span><br><span class="line">tar -zxvf zookeeper_3.5.6.tar.gz</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>进入到 <code>conf</code> 目录，拷贝 <code>zoo_sample.cfg</code> 文件并创建 <code>zoo.cfg</code></li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入到 conf 目录</span></span><br><span class="line">cd /opt/zookeeper_3.5.6/conf/</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拷贝</span></span><br><span class="line">cp zoo_sample.cfg zoo.cfg</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>创建 <code>data</code> 目录</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建 zookeeper 存储目录</span></span><br><span class="line">mkdir -p /opt/zookeeper_3.5.6/data</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>修改 <code>zoo.cfg</code> 文件的 <code>dataDir</code> 参数</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改 zoo.cfg</span></span><br><span class="line">vim /opt/zookeeper_3.5.6/conf/zoo.cfg</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dataDir=/opt/zookeeper_3.5.6/data</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>启动 <code>zookeeper</code>，并且查看其状态</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/opt/zookeeper_3.5.6/bin/zkServer.sh start</span><br><span class="line"></span><br><span class="line">/opt/zookeeper_3.5.6/bin/zkServer.sh status</span><br></pre></td></tr></table></figure>

<h4 id="集群部署"><a href="#集群部署" class="headerlink" title="集群部署"></a>集群部署</h4><p>集群部署前三步与单机部署一致</p>
<ol start="4">
<li>进入 <code>/opt</code> 目录并创建集群节点目录</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /opt</span><br><span class="line"></span><br><span class="line">mkdir -p /opt/zookeeper-cluster/zookeeper-1</span><br><span class="line">mkdir -p /opt/zookeeper-cluster/zookeeper-2</span><br><span class="line">mkdir -p /opt/zookeeper-cluster/zookeeper-3</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>分别拷贝 <code>/opt/zookeeper_3.5.6</code> 目录下的内容，到 <code>zookeeper</code> 集群的三个节点目录</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp -r /opt/zookeeper_3.5.6/* /opt/zookeeper-cluster/zookeeper-1</span><br><span class="line">cp -r /opt/zookeeper_3.5.6/* /opt/zookeeper-cluster/zookeeper-2</span><br><span class="line">cp -r /opt/zookeeper_3.5.6/* /opt/zookeeper-cluster/zookeeper-3</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>在 <code>zookeeper</code> 集群的三个节点的 <code>data</code> 目录下创建 <code>myid</code> 文件并且给与值</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt;/opt/zookeeper-cluster/zookeeper-1/data/myid</span><br><span class="line">echo 2 &gt;/opt/zookeeper-cluster/zookeeper-2/data/myid</span><br><span class="line">echo 3 &gt;/opt/zookeeper-cluster/zookeeper-3/data/myid</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>修改 <code>zoo.cfg</code> 文件的 <code>clientPort</code> 和 <code>dataDir</code> 参数，并且在每个节点都新增 <code>server.$&#123;id&#125;</code> 参数</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改 zoo.cfg</span></span><br><span class="line">vim /opt/zookeeper-cluster/zookeeper-1/conf/zoo.cfg</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dataDir=/opt/zookeeper-cluster/zookeeper-1/data</span><br><span class="line">clientPort=2181</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">server.服务器 <span class="built_in">id</span> = 服务器 ip 地址:服务器之间通信端口:服务器之间投票选举端口</span></span><br><span class="line">server.1=localhost:2881:3881</span><br><span class="line">server.2=localhost:2882:3882</span><br><span class="line">server.3=localhost:2883:3883</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改 zoo.cfg</span></span><br><span class="line">vim /opt/zookeeper-cluster/zookeeper-2/conf/zoo.cfg</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dataDir=/opt/zookeeper-cluster/zookeeper-2/data</span><br><span class="line">clientPort=2182</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">server.服务器 <span class="built_in">id</span> = 服务器 ip 地址:服务器之间通信端口:服务器之间投票选举端口</span></span><br><span class="line">server.1=localhost:2881:3881</span><br><span class="line">server.2=localhost:2882:3882</span><br><span class="line">server.3=localhost:2883:3883</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改 zoo.cfg</span></span><br><span class="line">vim /opt/zookeeper-cluster/zookeeper-3/conf/zoo.cfg</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dataDir=/opt/zookeeper-cluster/zookeeper-3/data</span><br><span class="line">clientPort=2183</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">server.服务器 <span class="built_in">id</span> = 服务器 ip 地址:服务器之间通信端口:服务器之间投票选举端口</span></span><br><span class="line">server.1=localhost:2881:3881</span><br><span class="line">server.2=localhost:2882:3882</span><br><span class="line">server.3=localhost:2883:3883</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>启动 <code>zookeeper</code> 集群，并且查看其状态</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/opt/zookeeper-cluster/zookeeper-1/bin/zkServer.sh start</span><br><span class="line">/opt/zookeeper-cluster/zookeeper-2/bin/zkServer.sh start</span><br><span class="line">/opt/zookeeper-cluster/zookeeper-3/bin/zkServer.sh start</span><br><span class="line"></span><br><span class="line">/opt/zookeeper-cluster/zookeeper-1/bin/zkServer.sh status</span><br><span class="line">/opt/zookeeper-cluster/zookeeper-2/bin/zkServer.sh status</span><br><span class="line">/opt/zookeeper-cluster/zookeeper-3/bin/zkServer.sh status</span><br></pre></td></tr></table></figure>

<p>附：关闭集群命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/opt/zookeeper-cluster/zookeeper-1/bin/zkServer.sh stop</span><br><span class="line">/opt/zookeeper-cluster/zookeeper-2/bin/zkServer.sh stop</span><br><span class="line">/opt/zookeeper-cluster/zookeeper-3/bin/zkServer.sh stop</span><br></pre></td></tr></table></figure>

<h3 id="kafka-1"><a href="#kafka-1" class="headerlink" title="kafka"></a>kafka</h3><p>由于 <code>kafka</code> 对 <code>zookeeper</code> 是强依赖，所以在部署 <code>kafka</code> 之前，先进行 <code>zookeeper</code> 的部署</p>
<p>蓝奏云：<a target="_blank" rel="noopener" href="https://meixiang.lanzouw.com/im1Cf1zudiwf">kafka_2.12-2.4.1.zip</a></p>
<p>先使用 <code>bandizip</code> 解压 <code>kafka_2.12-2.4.1.zip</code> 得到 <code>kafka_2.12-2.4.1.tgz</code></p>
<h4 id="单机部署-1"><a href="#单机部署-1" class="headerlink" title="单机部署"></a>单机部署</h4><ol>
<li>将 tar 包上传到 <code>/opt</code> 目录下，切换目录到 <code>/opt</code> 执行解压</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /opt</span><br><span class="line"></span><br><span class="line">tar -zxvf kafka_2.12-2.4.1.tgz</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>进入 <code>/opt/kafka_2.12-2.4.1/config</code> 目录</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/kafka_2.12-2.4.1/config</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>修改 <code>server.properties</code> 文件的 <code>broker.id</code> 和 <code>log.dirs</code> 和 <code>zookeeper.connect</code> 参数</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim server.properties</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定 broker 的 <span class="built_in">id</span></span></span><br><span class="line">broker.id=0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定 kafka 存储日志文件的目录</span></span><br><span class="line">log.dirs=/opt/kafka_2.12-2.4.1/kafka-logs</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置 zookeeper，由于 zookeeper 也是在本机部署所以是 localhost，格式 ip:端口号</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此处也可以配置 zookeeper 集群，格式 localhost:2181,localhost:2182,localhost:2183 使用逗号分隔</span></span><br><span class="line">zookeeper.connect=localhost:2181</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>启动 <code>kafka</code>，并且查看其状态</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动 kafka 并且后台运行</span></span><br><span class="line">nohup /opt/kafka_2.12-2.4.1/bin/kafka-server-start.sh /opt/kafka_2.12-2.4.1/config/server.properties &amp;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kafka 默认监听 9092 端口</span></span><br><span class="line">/opt/kafka_2.12-2.4.1/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list</span><br></pre></td></tr></table></figure>

<h4 id="集群部署-1"><a href="#集群部署-1" class="headerlink" title="集群部署"></a>集群部署</h4><p>集群部署第一步与单机部署一致</p>
<ol start="2">
<li>创建目录 <code>/opt/kafka-cluster</code>，并且拷贝 <code>/opt/kafka_2.12-2.4.1</code> 目录下的内容，到 <code>/opt/kafka-cluster</code> 集群目录下</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir /opt/kafka-cluster</span><br><span class="line"></span><br><span class="line">cp -r /opt/kafka_2.12-2.4.1/* /opt/kafka-cluster</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>拷贝三份 <code>server.properties</code> 配置文件，并且重命名</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp /opt/kafka-cluster/config/server.properties /opt/kafka-cluster/config/server-1.properties</span><br><span class="line">cp /opt/kafka-cluster/config/server.properties /opt/kafka-cluster/config/server-2.properties</span><br><span class="line">cp /opt/kafka-cluster/config/server.properties /opt/kafka-cluster/config/server-3.properties</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>进入 <code>/opt/kafka-cluster/config</code> 目录修改 <code>server-*.properties</code> 文件的 <code>broker.id</code> 和 <code>log.dirs</code> 和 <code>zookeeper.connect</code> 参数，添加 <code>listeners</code> 参数</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/kafka-cluster/config</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim server-1.properties</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定 broker 的 <span class="built_in">id</span></span></span><br><span class="line">broker.id=1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kafka 监听 9092 端口</span></span><br><span class="line">listeners=PLAINTEXT://:9092</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定 kafka 存储日志文件的目录</span></span><br><span class="line">log.dirs=/opt/kafka-cluster/kafka-logs-1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置 zookeeper，由于 zookeeper 也是在本机部署所以是 localhost，格式 ip:端口号</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此处也可以配置 zookeeper 集群，格式 localhost:2181,localhost:2182,localhost:2183 使用逗号分隔</span></span><br><span class="line">zookeeper.connect=localhost:2181,localhost:2182,localhost:2183</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim server-2.properties</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定 broker 的 <span class="built_in">id</span></span></span><br><span class="line">broker.id=2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kafka 监听 9093 端口</span></span><br><span class="line">listeners=PLAINTEXT://:9093</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定 kafka 存储日志文件的目录</span></span><br><span class="line">log.dirs=/opt/kafka-cluster/kafka-logs-2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置 zookeeper，由于 zookeeper 也是在本机部署所以是 localhost，格式 ip:端口号</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此处也可以配置 zookeeper 集群，格式 localhost:2181,localhost:2182,localhost:2183 使用逗号分隔</span></span><br><span class="line">zookeeper.connect=localhost:2181,localhost:2182,localhost:2183</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim server-3.properties</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定 broker 的 <span class="built_in">id</span></span></span><br><span class="line">broker.id=3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kafka 监听 9094 端口</span></span><br><span class="line">listeners=PLAINTEXT://:9094</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定 kafka 存储日志文件的目录</span></span><br><span class="line">log.dirs=/opt/kafka-cluster/kafka-logs-3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置 zookeeper，由于 zookeeper 也是在本机部署所以是 localhost，格式 ip:端口号</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此处也可以配置 zookeeper 集群，格式 localhost:2181,localhost:2182,localhost:2183 使用逗号分隔</span></span><br><span class="line">zookeeper.connect=localhost:2181,localhost:2182,localhost:2183</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>启动 <code>kafka</code> 集群，并且验证是否启动成功</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nohup /opt/kafka-cluster/bin/kafka-server-start.sh /opt/kafka-cluster/config/server-1.properties &amp;</span><br><span class="line">nohup /opt/kafka-cluster/bin/kafka-server-start.sh /opt/kafka-cluster/config/server-2.properties &amp;</span><br><span class="line">nohup /opt/kafka-cluster/bin/kafka-server-start.sh /opt/kafka-cluster/config/server-3.properties &amp;</span><br><span class="line"></span><br><span class="line">/opt/kafka-cluster/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list</span><br></pre></td></tr></table></figure>

<p>附：关闭集群命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/opt/kafka-cluster/bin/kafka-server-stop.sh /opt/kafka-cluster/config/server-1.properties &amp;</span><br><span class="line">/opt/kafka-cluster/bin/kafka-server-stop.sh /opt/kafka-cluster/config/server-2.properties &amp;</span><br><span class="line">/opt/kafka-cluster/bin/kafka-server-stop.sh /opt/kafka-cluster/config/server-3.properties &amp;</span><br></pre></td></tr></table></figure>

<h3 id="minikube"><a href="#minikube" class="headerlink" title="minikube"></a>minikube</h3><p><a target="_blank" rel="noopener" href="https://github.com/aliyuncontainerservice/minikube">https://github.com/aliyuncontainerservice/minikube</a></p>
<p>安装 minikube </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -LO https://kubernetes.oss-cn-hangzhou.aliyuncs.com/minikube/releases/v1.23.1/minikube-linux-amd64</span><br><span class="line">sudo install minikube-linux-amd64 /usr/local/bin/minikube &amp;&amp; <span class="built_in">rm</span> minikube-linux-amd64</span><br></pre></td></tr></table></figure>

<p>创建具有管理员访问权限的用户</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个新用户</span></span><br><span class="line">sudo useradd maysean</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置用户的密码</span></span><br><span class="line">sudo passwd maysean</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将用户添加到 wheel 组中</span></span><br><span class="line">sudo usermod -aG wheel maysean</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换用户</span></span><br><span class="line">su maysean</span><br></pre></td></tr></table></figure>

<p>将当前登录用户（由 <code>$USER</code> 变量指定）追加到 <code>docker</code> 组中</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod -aG docker <span class="variable">$USER</span> &amp;&amp; newgrp docker</span><br></pre></td></tr></table></figure>

<p>使 docker 成为默认驱动程序</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">minikube config <span class="built_in">set</span> driver docker</span><br></pre></td></tr></table></figure>

<p>启动 <code>minikube</code>，使用阿里云的镜像仓库</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">minikube start --image-mirror-country=<span class="string">&#x27;cn&#x27;</span> --image-repository=<span class="string">&#x27;registry.cn-hangzhou.aliyuncs.com/google_containers&#x27;</span></span><br></pre></td></tr></table></figure>

<p>验证安装结果</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">minikube status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例演示</span></span><br><span class="line">[maysean@localhost root]$  minikube status</span><br><span class="line">minikube</span><br><span class="line"><span class="built_in">type</span>: Control Plane</span><br><span class="line">host: Running</span><br><span class="line">kubelet: Running</span><br><span class="line">apiserver: Running</span><br><span class="line">kubeconfig: Configured</span><br></pre></td></tr></table></figure>

<p>给 minikube kubectl 取个别名 kubectl</p>
<p>设置的 <code>kubectl</code> 别名，当执行 <code>kubectl</code> 命令时，使它通过 <code>minikube</code> 的包装</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">alias</span> kubectl=<span class="string">&quot;minikube kubectl --&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="kubernetes（单机版）"><a href="#kubernetes（单机版）" class="headerlink" title="kubernetes（单机版）"></a>kubernetes（单机版）</h3><h4 id="版本介绍"><a href="#版本介绍" class="headerlink" title="版本介绍"></a>版本介绍</h4><blockquote>
<p>kubernetes 与 docker 存在版本对应关系</p>
</blockquote>
<p>此次安装的 <code>kubernetes</code> 版本：v1.20.9；<code>docker</code> 版本：v20.10.7</p>
<h4 id="虚拟机环境"><a href="#虚拟机环境" class="headerlink" title="虚拟机环境"></a>虚拟机环境</h4><p>一台 CentOS 7 64 位的虚拟机，IP 为 <code>192.168.200.131</code></p>
<p>如果只有一台 IP 为 <code>192.168.200.128</code> 的虚拟机，可以修改 <code>IP</code> 以及主机名完成</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname k8s-master</span><br><span class="line">sudo sed -i <span class="string">&#x27;s/192\.168\.200\.128/192.168.200.131/g&#x27;</span> /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class="line">systemctl restart network</span><br></pre></td></tr></table></figure>

<h4 id="部署过程"><a href="#部署过程" class="headerlink" title="部署过程"></a>部署过程</h4><p>k8s-master：禁用 firewalld；禁用 selinux，关闭 swap 分区，编辑hosts 文件；将桥接的 ipv4 流量传递到 iptables 的链，重启之后使用 <code>free -m</code> 查看 swap</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line">sudo sed -i <span class="string">&#x27;s/^SELINUX=enforcing$/SELINUX=disabled/&#x27;</span> /etc/selinux/config</span><br><span class="line">sed -ri <span class="string">&#x27;s/.*swap.*/#&amp;/&#x27;</span> /etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/modules-load.d/k8s.conf</span></span><br><span class="line"><span class="string">br_netfilter</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/sysctl.d/k8s.conf</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">sysctl --system</span><br><span class="line"></span><br><span class="line">reboot</span><br><span class="line">free -m</span><br></pre></td></tr></table></figure>

<blockquote>
<p>安装 docker，参考安装 docker 篇</p>
</blockquote>
<p>k8s-master：配置 k8s 的 yum 源地址</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/yum.repos.d/kubernetes.repo</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">repo_gpgcheck=0</span></span><br><span class="line"><span class="string">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span></span><br><span class="line"><span class="string">  http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>k8s-master：安装 kubelet、kubeadm、kubectl</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 kubelet、kubeadm、kubectl</span></span><br><span class="line">yum install -y kubelet-1.20.9 kubeadm-1.20.9 kubectl-1.20.9 --disableexcludes=kubernetes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 kubelet</span></span><br><span class="line">systemctl <span class="built_in">enable</span> --now kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 kubelet 状态</span></span><br><span class="line">systemctl status kubelet</span><br></pre></td></tr></table></figure>

<p>k8s-master：docker 登录 registry.cn-hangzhou.aliyuncs.com 仓库</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 退出登录 registry.cn-hangzhou.aliyuncs.com</span></span><br><span class="line">docker <span class="built_in">logout</span> registry.cn-hangzhou.aliyuncs.com</span><br><span class="line"><span class="comment"># 登录 registry.cn-hangzhou.aliyuncs.com</span></span><br><span class="line">docker login -u maysean -p wt264ydfk1jiggsu registry.cn-hangzhou.aliyuncs.com</span><br></pre></td></tr></table></figure>

<p>k8s-master：编写镜像拉取脚本，修改文件权限，执行脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">tee</span> ./images.sh &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义要拉取的镜像列表</span></span><br><span class="line">images=(</span><br><span class="line">    <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/maysean/calico-node:v3.20.6&quot;</span></span><br><span class="line">    <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/maysean/calico-pod2daemon-flexvol:v3.20.6&quot;</span></span><br><span class="line">    <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/maysean/calico-cni:v3.20.6&quot;</span></span><br><span class="line">    <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/maysean/calico-kube-controllers:v3.20.6&quot;</span></span><br><span class="line">    <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/maysean/kube-proxy:v1.20.9&quot;</span></span><br><span class="line">    <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/maysean/kube-controller-manager:v1.20.9&quot;</span></span><br><span class="line">    <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/maysean/kube-scheduler:v1.20.9&quot;</span></span><br><span class="line">    <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/maysean/kube-apiserver:v1.20.9&quot;</span></span><br><span class="line">    <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/maysean/etcd:3.4.13-0&quot;</span></span><br><span class="line">    <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/maysean/coredns:1.7.0&quot;</span></span><br><span class="line">    <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/maysean/pause:3.2&quot;</span></span><br><span class="line">    <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/maysean/kubernetesui-dashboard:v2.3.1&quot;</span></span><br><span class="line">    <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/maysean/kubernetesui-metrics-scraper:v1.0.6&quot;</span></span><br><span class="line">    <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/maysean/ingress-nginx-controller:v0.46.0&quot;</span></span><br><span class="line">    <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/maysean/jettech-kube-webhook-certgen:v1.5.1&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历镜像列表并逐个拉取镜像</span></span><br><span class="line"><span class="keyword">for</span> image <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;images[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Pulling image: <span class="variable">$image</span>&quot;</span></span><br><span class="line">    docker pull <span class="string">&quot;<span class="variable">$image</span>&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Error: Failed to pull image <span class="variable">$image</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;All images pulled successfully.&quot;</span></span><br><span class="line"></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拉取镜像</span></span><br><span class="line"><span class="built_in">chmod</span> +x ./images.sh &amp;&amp; ./images.sh</span><br></pre></td></tr></table></figure>

<p>k8s-master：初始化 kubeadm，注意 <code>--apiserver-advertise-address</code>；<code>--service-cidr</code>；<code>--pod-network-cidr</code> 3 个网络互相不能重叠</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果是单机部署，先执行；集群部署则不用</span></span><br><span class="line">sysctl -w net.ipv4.ip_forward=1</span><br><span class="line"></span><br><span class="line">kubeadm init \</span><br><span class="line">--apiserver-advertise-address=192.168.200.131 \</span><br><span class="line">--control-plane-endpoint=k8s-master \</span><br><span class="line">--image-repository registry.cn-hangzhou.aliyuncs.com/maysean \</span><br><span class="line">--kubernetes-version v1.20.9 \</span><br><span class="line">--service-cidr=10.96.0.0/12 \</span><br><span class="line">--pod-network-cidr=10.244.0.0/16</span><br></pre></td></tr></table></figure>

<p>k8s-master：初始化成功之后会打印以下信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">Alternatively, <span class="keyword">if</span> you are the root user, you can run:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">You can now <span class="built_in">join</span> any number of control-plane nodes by copying certificate authorities</span><br><span class="line">and service account keys on each node and <span class="keyword">then</span> running the following as root:</span><br><span class="line"></span><br><span class="line">  kubeadm <span class="built_in">join</span> k8s-master:6443 --token euztag.6yjbhn94ehg6nhn7 \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:a6e917b751e424c7a761c2276ae02db95d87ba5a3cc6b374182519ce89aba28b \</span><br><span class="line">    --control-plane </span><br><span class="line"></span><br><span class="line">Then you can <span class="built_in">join</span> any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm <span class="built_in">join</span> k8s-master:6443 --token euztag.6yjbhn94ehg6nhn7 \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:a6e917b751e424c7a761c2276ae02db95d87ba5a3cc6b374182519ce89aba28b </span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 因为默认 master 不能部署 pod，有污点，需要去掉污点或者新增一个 node</span></span><br><span class="line">kubectl get node -o yaml | grep taint -A 5 <span class="comment"># 执行后看到有输出说明有污点</span></span><br><span class="line">kubectl taint nodes --all node-role.kubernetes.io/master-   <span class="comment"># 执行这句就行，就是取消污点</span></span><br></pre></td></tr></table></figure>

<p>k8s-master：创建 kube 的配置文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># root 用户可执行</span></span><br><span class="line"><span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br></pre></td></tr></table></figure>

<p>k8s-master：创建 calico.yaml 文件，并且复制 <a target="_blank" rel="noopener" href="https://gitee.com/maysean/kubernetes/blob/master/calico.yaml">calico.yaml</a> 的内容，按需要修改</p>
<p>在文件中 搜索 <code>CALICO_IPV4POOL_CIDR </code> 按照 <code>kubeadm init</code> 初始化时指定的 <code>--pod-network-cidr</code> 值修改 <code>CALICO_IPV4POOL_CIDR</code> 的 <code>value</code> 值，安装 <code>calico</code> 网络插件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f calico.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 附：卸载网络插件（按需执行）</span></span><br><span class="line">kubectl delete -f calico.yaml</span><br></pre></td></tr></table></figure>

<p>k8s-master：集群状况查看</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看集群节点，全部都是 Ready 就是正常的</span></span><br><span class="line">kubectl get nodes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看集群 pod，全部都是 Running 就是正常的</span></span><br><span class="line">kubectl get pods -A</span><br></pre></td></tr></table></figure>

<p>k8s-master：安装补全命令的包</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">yum -y install bash-completion</span><br><span class="line">kubectl completion bash</span><br><span class="line"><span class="built_in">source</span> /usr/share/bash-completion/bash_completion</span><br><span class="line">kubectl completion bash &gt;/etc/profile.d/kubectl.sh</span><br><span class="line"><span class="built_in">source</span> /etc/profile.d/kubectl.sh</span><br><span class="line"><span class="built_in">cat</span>  &gt;&gt;  /root/.bashrc &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">source /etc/profile.d/kubectl.sh</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>k8s-master：创建 recommended.yaml 文件，并且复制 <a target="_blank" rel="noopener" href="https://gitee.com/maysean/kubernetes/blob/master/recommended.yaml">recommended.yaml</a> 的内容</p>
<p>部署可视化界面，等到 Running</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f recommended.yaml</span><br></pre></td></tr></table></figure>

<p>k8s-master：设置访问端口</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改配置文件，找到 type，将 ClusterIP 改成 NodePort</span></span><br><span class="line">kubectl edit svc kubernetes-dashboard -n kubernetes-dashboard</span><br><span class="line"></span><br><span class="line"><span class="comment"># 找到端口，在安全组放行</span></span><br><span class="line">kubectl get svc -A | grep kubernetes-dashboard</span><br><span class="line"></span><br><span class="line"><span class="comment"># 32369 就是访问端口，浏览器地址栏输入 https://192.168.200.131:32369 访问，</span></span><br><span class="line"><span class="comment"># 如果显示隐私错误，在浏览器空白处实用键盘输入 thisisunsafe 然后回车</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get svc -A | grep kubernetes-dashboard</span></span><br><span class="line">kubernetes-dashboard   dashboard-metrics-scraper   ClusterIP   10.105.47.192   &lt;none&gt;        8000/TCP                 16m</span><br><span class="line">kubernetes-dashboard   kubernetes-dashboard        NodePort    10.96.193.78    &lt;none&gt;        443:32369/TCP            16m</span><br></pre></td></tr></table></figure>

<p>k8s-master：创建访问账号</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">tee</span> ./dash-usr.yaml &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment"># 创建访问账号，准备一个 yaml 文件，加入下面配置</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 k8s 集群中创建资源</span></span><br><span class="line">kubectl apply -f dash-usr.yaml</span><br></pre></td></tr></table></figure>

<p>获取访问令牌</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kubernetes-dashboard get secret $(kubectl -n kubernetes-dashboard get sa/admin-user -o jsonpath=<span class="string">&quot;&#123;.secrets[0].name&#125;&quot;</span>) -o go-template=<span class="string">&quot;&#123;&#123;.data.token | base64decode&#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<p>复制 token 粘贴在页面上，点击登录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJSUzI1NiIsImtpZCI6IlhnZlJCY2lHaXc5bXhsa3NFdFQxR2c2Q2d6T2F2VmtWT2xSQXp1eTlaaHMifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLTVmbmY5Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJkZmZiZjczNy00ZGEzLTQwMzItODIwYi1jMDVhZjRhY2FkYWUiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZXJuZXRlcy1kYXNoYm9hcmQ6YWRtaW4tdXNlciJ9.mqLlRD8vz90p-sZeescDiC-48kzKncVZE0maFMt8MEUN-c3eCtZLYYsILzsVb73js--h_Nbxbr24N-eqeUNbC8NQ-b4Y78n3AGuIcDqmYLEik7UQ0_IiljokM0Aw_uBAdJoq9kU_26eIBFXUt1TAPtkDe3fUeqfyOLO6Mm9tDoKpDWlJAbHXssU4lMBz2X7mdeBMeZhh2h863hs4pjTNaKymJsKtKIXVtCCHoyz-uT0IszTbbtj1tHaQ7zSY9F6yVWfMpxX4drdcTSw-fvK1A4eVejhVggU_Ot6_9eqJuTvbcWza9UZybzrpfXrfiQ46SlnnpqZ5R6e8XbQ-36U2qA</span><br></pre></td></tr></table></figure>

<h3 id="kubernetes-集群"><a href="#kubernetes-集群" class="headerlink" title="kubernetes 集群"></a>kubernetes 集群</h3><h4 id="版本介绍-1"><a href="#版本介绍-1" class="headerlink" title="版本介绍"></a>版本介绍</h4><blockquote>
<p>kubernetes 与 docker 存在版本对应关系</p>
</blockquote>
<p>此次安装的 <code>kubernetes</code> 版本：v1.20.9；<code>docker</code> 版本：v20.10.7</p>
<h4 id="虚拟机环境-1"><a href="#虚拟机环境-1" class="headerlink" title="虚拟机环境"></a>虚拟机环境</h4><p>三台 CentOS 7 64 位的虚拟机，IP 分别为 <code>192.168.200.131</code>；<code>192.168.200.132</code>；<code>192.168.200.133</code></p>
<p>如果只有一台 IP 为 <code>192.168.200.128</code> 的虚拟机，可以通过克隆，修改 <code>IP</code> 以及主机名完成</p>
<p>分别在三台虚拟机上执行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname k8s-master</span><br><span class="line">sudo sed -i <span class="string">&#x27;s/192\.168\.200\.128/192.168.200.131/g&#x27;</span> /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class="line">systemctl restart network</span><br><span class="line"></span><br><span class="line">hostnamectl set-hostname k8s-node1</span><br><span class="line">sudo sed -i <span class="string">&#x27;s/192\.168\.200\.128/192.168.200.132/g&#x27;</span> /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class="line">systemctl restart network</span><br><span class="line"></span><br><span class="line">hostnamectl set-hostname k8s-node2</span><br><span class="line">sudo sed -i <span class="string">&#x27;s/192\.168\.200\.128/192.168.200.133/g&#x27;</span> /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class="line">systemctl restart network</span><br></pre></td></tr></table></figure>

<p>k8s-master：配置 hosts 文件，本地解析 k8s-node1 和 k8s-node2 地址</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;&gt; /etc/hosts &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">192.168.200.131 k8s-master</span></span><br><span class="line"><span class="string">192.168.200.132 k8s-node1</span></span><br><span class="line"><span class="string">192.168.200.133 k8s-node2</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h4 id="部署过程-1"><a href="#部署过程-1" class="headerlink" title="部署过程"></a>部署过程</h4><p>k8s-master、k8s-node1、k8s-node2：禁用 firewalld；禁用 selinux，关闭 swap 分区，编辑hosts 文件；将桥接的 ipv4 流量传递到 iptables 的链，重启之后使用 <code>free -m</code> 查看 swap</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line">sudo sed -i <span class="string">&#x27;s/^SELINUX=enforcing$/SELINUX=disabled/&#x27;</span> /etc/selinux/config</span><br><span class="line">sed -ri <span class="string">&#x27;s/.*swap.*/#&amp;/&#x27;</span> /etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/modules-load.d/k8s.conf</span></span><br><span class="line"><span class="string">br_netfilter</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/sysctl.d/k8s.conf</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">sysctl --system</span><br><span class="line"></span><br><span class="line">reboot</span><br><span class="line">free -m</span><br></pre></td></tr></table></figure>

<blockquote>
<p>安装 docker，参考安装 docker 篇</p>
</blockquote>
<p>k8s-master、k8s-node1、k8s-node2：配置 k8s 的 yum 源地址</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/yum.repos.d/kubernetes.repo</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">repo_gpgcheck=0</span></span><br><span class="line"><span class="string">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span></span><br><span class="line"><span class="string">  http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>k8s-master、k8s-node1、k8s-node2：安装 kubelet、kubeadm、kubectl</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 kubelet、kubeadm、kubectl</span></span><br><span class="line">yum install -y kubelet-1.20.9 kubeadm-1.20.9 kubectl-1.20.9 --disableexcludes=kubernetes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 kubelet</span></span><br><span class="line">systemctl <span class="built_in">enable</span> --now kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 kubelet 状态</span></span><br><span class="line">systemctl status kubelet</span><br></pre></td></tr></table></figure>

<p>k8s-master、k8s-node1、k8s-node2：docker 登录 registry.cn-hangzhou.aliyuncs.com 仓库</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 退出登录 registry.cn-hangzhou.aliyuncs.com</span></span><br><span class="line">docker <span class="built_in">logout</span> registry.cn-hangzhou.aliyuncs.com</span><br><span class="line"><span class="comment"># 登录 registry.cn-hangzhou.aliyuncs.com</span></span><br><span class="line">docker login -u maysean -p wt264ydfk1jiggsu registry.cn-hangzhou.aliyuncs.com</span><br></pre></td></tr></table></figure>

<p>k8s-master：编写镜像拉取脚本，修改文件权限，执行脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">tee</span> ./images.sh &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义要拉取的镜像列表</span></span><br><span class="line">images=(</span><br><span class="line">    <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/maysean/calico-node:v3.20.6&quot;</span></span><br><span class="line">    <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/maysean/calico-pod2daemon-flexvol:v3.20.6&quot;</span></span><br><span class="line">    <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/maysean/calico-cni:v3.20.6&quot;</span></span><br><span class="line">    <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/maysean/calico-kube-controllers:v3.20.6&quot;</span></span><br><span class="line">    <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/maysean/kube-proxy:v1.20.9&quot;</span></span><br><span class="line">    <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/maysean/kube-controller-manager:v1.20.9&quot;</span></span><br><span class="line">    <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/maysean/kube-scheduler:v1.20.9&quot;</span></span><br><span class="line">    <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/maysean/kube-apiserver:v1.20.9&quot;</span></span><br><span class="line">    <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/maysean/etcd:3.4.13-0&quot;</span></span><br><span class="line">    <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/maysean/coredns:1.7.0&quot;</span></span><br><span class="line">    <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/maysean/pause:3.2&quot;</span></span><br><span class="line">    <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/maysean/kubernetesui-dashboard:v2.3.1&quot;</span></span><br><span class="line">    <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/maysean/kubernetesui-metrics-scraper:v1.0.6&quot;</span></span><br><span class="line">    <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/maysean/ingress-nginx-controller:v0.46.0&quot;</span></span><br><span class="line">    <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/maysean/jettech-kube-webhook-certgen:v1.5.1&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历镜像列表并逐个拉取镜像</span></span><br><span class="line"><span class="keyword">for</span> image <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;images[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Pulling image: <span class="variable">$image</span>&quot;</span></span><br><span class="line">    docker pull <span class="string">&quot;<span class="variable">$image</span>&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Error: Failed to pull image <span class="variable">$image</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;All images pulled successfully.&quot;</span></span><br><span class="line"></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拉取镜像</span></span><br><span class="line"><span class="built_in">chmod</span> +x ./images.sh &amp;&amp; ./images.sh</span><br></pre></td></tr></table></figure>

<p>k8s-master：初始化 kubeadm，注意 <code>--apiserver-advertise-address</code>；<code>--service-cidr</code>；<code>--pod-network-cidr</code> 3 个网络互相不能重叠</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果是单机部署，先执行；集群部署则不用</span></span><br><span class="line">sysctl -w net.ipv4.ip_forward=1</span><br><span class="line"></span><br><span class="line">kubeadm init \</span><br><span class="line">--apiserver-advertise-address=192.168.200.131 \</span><br><span class="line">--control-plane-endpoint=k8s-master \</span><br><span class="line">--image-repository registry.cn-hangzhou.aliyuncs.com/maysean \</span><br><span class="line">--kubernetes-version v1.20.9 \</span><br><span class="line">--service-cidr=10.96.0.0/12 \</span><br><span class="line">--pod-network-cidr=10.244.0.0/16</span><br></pre></td></tr></table></figure>

<p>k8s-master：初始化成功之后会打印以下信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">Alternatively, <span class="keyword">if</span> you are the root user, you can run:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">You can now <span class="built_in">join</span> any number of control-plane nodes by copying certificate authorities</span><br><span class="line">and service account keys on each node and <span class="keyword">then</span> running the following as root:</span><br><span class="line"></span><br><span class="line">  kubeadm <span class="built_in">join</span> k8s-master:6443 --token euztag.6yjbhn94ehg6nhn7 \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:a6e917b751e424c7a761c2276ae02db95d87ba5a3cc6b374182519ce89aba28b \</span><br><span class="line">    --control-plane </span><br><span class="line"></span><br><span class="line">Then you can <span class="built_in">join</span> any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm <span class="built_in">join</span> k8s-master:6443 --token euztag.6yjbhn94ehg6nhn7 \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:a6e917b751e424c7a761c2276ae02db95d87ba5a3cc6b374182519ce89aba28b </span><br></pre></td></tr></table></figure>

<p>k8s-master：创建 kube 的配置文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># root 用户可执行</span></span><br><span class="line"><span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br></pre></td></tr></table></figure>

<p>k8s-master：创建 calico.yaml 文件，并且复制 <a target="_blank" rel="noopener" href="https://gitee.com/maysean/kubernetes/blob/master/calico.yaml">calico.yaml</a> 的内容，按需要修改</p>
<p>在文件中 搜索 <code>CALICO_IPV4POOL_CIDR </code> 按照 <code>kubeadm init</code> 初始化时指定的 <code>--pod-network-cidr</code> 值修改 <code>CALICO_IPV4POOL_CIDR</code> 的 <code>value</code> 值，安装 <code>calico</code> 网络插件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f calico.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 附：卸载网络插件（按需执行）</span></span><br><span class="line">kubectl delete -f calico.yaml</span><br></pre></td></tr></table></figure>

<p>k8s-node1、k8s-node2：加入 k8s 集群，以下两种方式可选其中一种</p>
<ol>
<li>此 token 有效期为 24 小时</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm <span class="built_in">join</span> k8s-master:6443 --token euztag.6yjbhn94ehg6nhn7 \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:a6e917b751e424c7a761c2276ae02db95d87ba5a3cc6b374182519ce89aba28b </span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成永不过期 token，获取 hash 码，</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token create --ttl 0</span><br><span class="line">openssl x509 -pubkey -<span class="keyword">in</span> /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed <span class="string">&#x27;s/^.* //&#x27;</span></span><br></pre></td></tr></table></figure>

<p>将生成的 token 和 hash 码分别替换掉 <code>&lt;token&gt;</code> 和 <code>&lt;hash&gt;</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm <span class="built_in">join</span> k8s-master:6443 --token &lt;token&gt; \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:&lt;<span class="built_in">hash</span>&gt;</span><br></pre></td></tr></table></figure>

<p>k8s-master：集群状况查看</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看集群节点，全部都是 Ready 就是正常的</span></span><br><span class="line">kubectl get nodes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看集群 pod，全部都是 Running 就是正常的</span></span><br><span class="line">kubectl get pods -A</span><br></pre></td></tr></table></figure>

<h4 id="补全命令"><a href="#补全命令" class="headerlink" title="补全命令"></a>补全命令</h4><p>k8s-master、k8s-node1、k8s-node2：安装补全命令的包</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">yum -y install bash-completion</span><br><span class="line">kubectl completion bash</span><br><span class="line"><span class="built_in">source</span> /usr/share/bash-completion/bash_completion</span><br><span class="line">kubectl completion bash &gt;/etc/profile.d/kubectl.sh</span><br><span class="line"><span class="built_in">source</span> /etc/profile.d/kubectl.sh</span><br><span class="line"><span class="built_in">cat</span>  &gt;&gt;  /root/.bashrc &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">source /etc/profile.d/kubectl.sh</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h4 id="配置-kubectl-命令"><a href="#配置-kubectl-命令" class="headerlink" title="配置 kubectl 命令"></a>配置 kubectl 命令</h4><p>k8s-node1、k8s-node2：配置 <code>kubectl</code> 命令</p>
<p><code>kubectl</code> 需要一个配置文件（通常是 <code>~/.kube/config</code>）来连接到 Kubernetes API 服务器。你可以通过以下命令检查配置文件是否存在：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> ~/.kube/config</span><br></pre></td></tr></table></figure>

<p>k8s-master：从主节点（master node）复制配置文件到从节点</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /root/.kube</span><br><span class="line"><span class="comment"># USER 替换成实际在 k8s-node1 节点上登录的用户，例如：root</span></span><br><span class="line"><span class="comment"># scp /etc/kubernetes/admin.conf &#123;USER&#125;@k8s-node1:~/.kube/config</span></span><br><span class="line">scp /etc/kubernetes/admin.conf root@k8s-node1:~/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -p /root/.kube</span><br><span class="line"><span class="comment"># USER 替换成实际在 k8s-node2 节点上登录的用户，例如：root</span></span><br><span class="line"><span class="comment"># scp /etc/kubernetes/admin.conf &#123;USER&#125;@k8s-node2:~/.kube/config</span></span><br><span class="line">scp /etc/kubernetes/admin.conf root@k8s-node2:~/.kube/config</span><br></pre></td></tr></table></figure>

<p>k8s-node1、k8s-node2：从节点上设置 <code>KUBECONFIG</code> 环境变量：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> KUBECONFIG=~/.kube/config</span><br></pre></td></tr></table></figure>

<h4 id="可视化界面"><a href="#可视化界面" class="headerlink" title="可视化界面"></a>可视化界面</h4><p>k8s-master：创建 recommended.yaml 文件，并且复制 <a target="_blank" rel="noopener" href="https://gitee.com/maysean/kubernetes/blob/master/recommended.yaml">recommended.yaml</a> 的内容</p>
<p>部署可视化界面，等到 Running</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f recommended.yaml</span><br></pre></td></tr></table></figure>

<p>k8s-master：设置访问端口</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改配置文件，找到 type，将 ClusterIP 改成 NodePort</span></span><br><span class="line">kubectl edit svc kubernetes-dashboard -n kubernetes-dashboard</span><br><span class="line"></span><br><span class="line"><span class="comment"># 找到端口，在安全组放行</span></span><br><span class="line">kubectl get svc -A | grep kubernetes-dashboard</span><br><span class="line"></span><br><span class="line"><span class="comment"># 32369 就是访问端口，浏览器地址栏输入 https://192.168.200.131:32369 访问，</span></span><br><span class="line"><span class="comment"># 如果显示隐私错误，在浏览器空白处实用键盘输入 thisisunsafe 然后回车</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get svc -A | grep kubernetes-dashboard</span></span><br><span class="line">kubernetes-dashboard   dashboard-metrics-scraper   ClusterIP   10.105.47.192   &lt;none&gt;        8000/TCP                 16m</span><br><span class="line">kubernetes-dashboard   kubernetes-dashboard        NodePort    10.96.193.78    &lt;none&gt;        443:32369/TCP            16m</span><br></pre></td></tr></table></figure>

<p>k8s-master：创建访问账号</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">tee</span> ./dash-usr.yaml &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment"># 创建访问账号，准备一个 yaml 文件，加入下面配置</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 k8s 集群中创建资源</span></span><br><span class="line">kubectl apply -f dash-usr.yaml</span><br></pre></td></tr></table></figure>

<p>获取访问令牌</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kubernetes-dashboard get secret $(kubectl -n kubernetes-dashboard get sa/admin-user -o jsonpath=<span class="string">&quot;&#123;.secrets[0].name&#125;&quot;</span>) -o go-template=<span class="string">&quot;&#123;&#123;.data.token | base64decode&#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<p>复制 token 粘贴在页面上，点击登录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJSUzI1NiIsImtpZCI6IlhnZlJCY2lHaXc5bXhsa3NFdFQxR2c2Q2d6T2F2VmtWT2xSQXp1eTlaaHMifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLTVmbmY5Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJkZmZiZjczNy00ZGEzLTQwMzItODIwYi1jMDVhZjRhY2FkYWUiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZXJuZXRlcy1kYXNoYm9hcmQ6YWRtaW4tdXNlciJ9.mqLlRD8vz90p-sZeescDiC-48kzKncVZE0maFMt8MEUN-c3eCtZLYYsILzsVb73js--h_Nbxbr24N-eqeUNbC8NQ-b4Y78n3AGuIcDqmYLEik7UQ0_IiljokM0Aw_uBAdJoq9kU_26eIBFXUt1TAPtkDe3fUeqfyOLO6Mm9tDoKpDWlJAbHXssU4lMBz2X7mdeBMeZhh2h863hs4pjTNaKymJsKtKIXVtCCHoyz-uT0IszTbbtj1tHaQ7zSY9F6yVWfMpxX4drdcTSw-fvK1A4eVejhVggU_Ot6_9eqJuTvbcWza9UZybzrpfXrfiQ46SlnnpqZ5R6e8XbQ-36U2qA</span><br></pre></td></tr></table></figure>

<h4 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h4><p>k8s-master：创建 deploy.yaml 文件，并且复制 <a target="_blank" rel="noopener" href="https://gitee.com/maysean/kubernetes/blob/master/deploy.yaml">deploy.yaml</a> 的内容</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装资源</span></span><br><span class="line">kubectl apply -f deploy.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查安装的结果</span></span><br><span class="line">kubectl get pod,svc -n ingress-nginx</span><br></pre></td></tr></table></figure>

<p>未完待续…</p>
<h3 id="k8s-学习心得"><a href="#k8s-学习心得" class="headerlink" title="k8s 学习心得"></a>k8s 学习心得</h3><p>在实际项目开发中，资源名称和命名空间的命名通常遵循一定的规范和最佳实践，以确保资源的可读性、可维护性和唯一性。以下是一些常见的命名约定和建议：</p>
<h4 id="资源名称"><a href="#资源名称" class="headerlink" title="资源名称"></a>资源名称</h4><p>资源名称应该简洁、描述性强，并且遵循 Kubernetes 的命名规则（只能包含小写字母、数字和短划线，且必须以字母开头和结尾）。</p>
<p>常见命名约定</p>
<ol>
<li><p><strong>应用名称</strong>：</p>
<ul>
<li>使用应用程序的名称作为资源名称的一部分。</li>
<li>例如：<code>myapp</code>, <code>webserver</code>, <code>database</code>.</li>
</ul>
</li>
<li><p><strong>环境</strong>：</p>
<ul>
<li>在资源名称中包含环境信息（如 <code>dev</code>, <code>test</code>, <code>prod</code>）。</li>
<li>例如：<code>myapp-dev</code>, <code>webserver-prod</code>.</li>
</ul>
</li>
<li><p><strong>功能或角色</strong>：</p>
<ul>
<li>在资源名称中包含资源的功能或角色。</li>
<li>例如：<code>myapp-backend</code>, <code>myapp-frontend</code>.</li>
</ul>
</li>
<li><p><strong>版本号</strong>：</p>
<ul>
<li>在资源名称中包含版本号（如果需要）。</li>
<li>例如：<code>myapp-v1</code>, <code>myapp-v2</code>.</li>
</ul>
</li>
</ol>
<h4 id="命名空间"><a href="#命名空间" class="headerlink" title="命名空间"></a>命名空间</h4><p>命名空间用于逻辑隔离资源，通常根据环境、团队或项目进行划分。</p>
<h4 id="常见命名约定"><a href="#常见命名约定" class="headerlink" title="常见命名约定"></a>常见命名约定</h4><ol>
<li><p><strong>环境</strong>：</p>
<ul>
<li>使用环境名称作为命名空间名称。</li>
<li>例如：<code>development</code>, <code>staging</code>, <code>production</code>.</li>
</ul>
</li>
<li><p><strong>团队或部门</strong>：</p>
<ul>
<li>使用团队或部门名称作为命名空间名称。</li>
<li>例如：<code>frontend-team</code>, <code>backend-team</code>.</li>
</ul>
</li>
<li><p><strong>项目或应用</strong>：</p>
<ul>
<li>使用项目或应用名称作为命名空间名称。</li>
<li>例如：<code>project-alpha</code>, <code>project-beta</code>.</li>
</ul>
</li>
<li><p><strong>组合使用</strong>：</p>
<ul>
<li>结合环境和项目名称进行命名。</li>
<li>例如：<code>dev-myapp</code>, <code>prod-myapp</code>.</li>
</ul>
</li>
</ol>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><p>以下是一个实际项目中可能的资源名称和命名空间的示例：</p>
<h4 id="命名空间-1"><a href="#命名空间-1" class="headerlink" title="命名空间"></a>命名空间</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">development</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">production</span></span><br></pre></td></tr></table></figure>

<h4 id="Pod-定义"><a href="#Pod-定义" class="headerlink" title="Pod 定义"></a>Pod 定义</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-backend</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">development</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">myapp-backend:latest</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-backend</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">production</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">myapp-backend:latest</span></span><br></pre></td></tr></table></figure>

<h3 id="更新-Kubernetes-资源中容器镜像"><a href="#更新-Kubernetes-资源中容器镜像" class="headerlink" title="更新 Kubernetes 资源中容器镜像"></a>更新 Kubernetes 资源中容器镜像</h3><p><code>kubectl set image</code> 是一个用于更新 Kubernetes 资源中容器镜像的命令。它可以在不修改原始 YAML 文件的情况下，直接更新正在运行的 Deployment、DaemonSet、StatefulSet 等资源的镜像版本。</p>
<h4 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h4><p>以下是 <code>kubectl set image</code> 命令的基本语法：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">set</span> image &lt;resource_type&gt;/&lt;resource_name&gt; &lt;container_name&gt;=&lt;new_image&gt;</span><br></pre></td></tr></table></figure>

<h4 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h4><p>假设你有一个名为 <code>my-deployment</code> 的 Deployment，其中包含一个名为 <code>my-container</code> 的容器。你想将这个容器的镜像更新为 <code>nginx:1.19</code>，可以使用以下命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">set</span> image deployment/my-deployment my-container=nginx:1.19</span><br></pre></td></tr></table></figure>

<h4 id="多个容器"><a href="#多个容器" class="headerlink" title="多个容器"></a>多个容器</h4><p>如果你的 Deployment 中有多个容器，你可以一次性更新多个容器的镜像。例如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">set</span> image deployment/my-deployment my-container1=nginx:1.19 my-container2=redis:6.0</span><br></pre></td></tr></table></figure>

<h4 id="回滚"><a href="#回滚" class="headerlink" title="回滚"></a>回滚</h4><p>如果新镜像有问题，你可以使用 <code>kubectl rollout undo</code> 命令回滚到之前的版本。例如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout undo deployment/my-deployment</span><br></pre></td></tr></table></figure>

<h4 id="检查更新状态"><a href="#检查更新状态" class="headerlink" title="检查更新状态"></a>检查更新状态</h4><p>你可以使用 <code>kubectl rollout status</code> 命令来检查更新的状态。例如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout status deployment/my-deployment</span><br></pre></td></tr></table></figure>

<h4 id="示例-YAML"><a href="#示例-YAML" class="headerlink" title="示例 YAML"></a>示例 YAML</h4><p>假设你有以下 Deployment YAML 文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">my-app</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.18</span></span><br></pre></td></tr></table></figure>

<p>你可以使用 <code>kubectl set image</code> 命令将 <code>nginx:1.18</code> 更新为 <code>nginx:1.19</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">set</span> image deployment/my-deployment my-container=nginx:1.19</span><br></pre></td></tr></table></figure>

<p>更新后，Deployment 的镜像将变为 <code>nginx:1.19</code>，并且 Kubernetes 会自动进行滚动更新，将旧的 Pod 替换为新的 Pod。</p>
<h3 id="SVC"><a href="#SVC" class="headerlink" title="SVC"></a>SVC</h3><p>要通过 YAML 文件在 Kubernetes 中创建一个服务（Service），你可以按照以下步骤进行。下面是一个示例 YAML 文件，用于创建一个 <code>ClusterIP</code> 类型的服务，以及如何将其应用到 Kubernetes 集群中。</p>
<h4 id="示例-YAML-文件"><a href="#示例-YAML-文件" class="headerlink" title="示例 YAML 文件"></a>示例 YAML 文件</h4><p>以下是一个示例 YAML 文件，用于创建一个名为 <code>nginx-service</code> 的 <code>ClusterIP</code> 类型的服务，将其端口 <code>80</code> 映射到目标端口 <code>80</code>。</p>
<p>ClusterIP 类型的服务</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<h4 id="创建服务"><a href="#创建服务" class="headerlink" title="创建服务"></a>创建服务</h4><ol>
<li><p><strong>保存 YAML 文件</strong>：将上述内容保存到一个名为 <code>nginx-service.yaml</code> 的文件中。</p>
</li>
<li><p><strong>应用 YAML 文件</strong>：使用 <code>kubectl apply</code> 命令将服务应用到 Kubernetes 集群中。</p>
</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f nginx-service.yaml</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>验证服务</strong>：确保服务已经成功创建并运行。</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc nginx-service</span><br></pre></td></tr></table></figure>

<p>NodePort 类型的服务</p>
<p>如果你希望从集群外部访问服务，可以创建一个 <code>NodePort</code> 类型的服务。以下是一个示例 YAML 文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30080</span>  <span class="comment"># 可选，指定 NodePort 范围内的端口</span></span><br></pre></td></tr></table></figure>

<h4 id="LoadBalancer-类型的服务"><a href="#LoadBalancer-类型的服务" class="headerlink" title="LoadBalancer 类型的服务"></a>LoadBalancer 类型的服务</h4><p>如果你的 Kubernetes 集群运行在支持负载均衡的云提供商上（如 AWS、GCP、Azure），你可以创建一个 <code>LoadBalancer</code> 类型的服务。以下是一个示例 YAML 文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<h4 id="完整示例"><a href="#完整示例" class="headerlink" title="完整示例"></a>完整示例</h4><p>假设你有一个名为 <code>nginx-deploy</code> 的 Deployment，以下是完整的 Deployment 和 Service YAML 文件示例：</p>
<h5 id="Deployment-YAML-文件"><a href="#Deployment-YAML-文件" class="headerlink" title="Deployment YAML 文件"></a>Deployment YAML 文件</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deploy</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span> <span class="comment"># pod 的 label</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<h5 id="Service-YAML-文件"><a href="#Service-YAML-文件" class="headerlink" title="Service YAML 文件"></a>Service YAML 文件</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span>  <span class="comment"># 或者 ClusterIP, LoadBalancer</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span> <span class="comment"># 与 pod 进行绑定</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30080</span>  <span class="comment"># 仅在 type: NodePort 时需要</span></span><br></pre></td></tr></table></figure>

<h5 id="应用-YAML-文件"><a href="#应用-YAML-文件" class="headerlink" title="应用 YAML 文件"></a>应用 YAML 文件</h5><ol>
<li><p><strong>保存 Deployment 和 Service YAML 文件</strong>：将上述内容分别保存到 <code>nginx-deploy.yaml</code> 和 <code>nginx-service.yaml</code> 文件中。</p>
</li>
<li><p><strong>应用 Deployment 和 Service</strong>：</p>
</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f nginx-deploy.yaml</span><br><span class="line">kubectl apply -f nginx-service.yaml</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>验证 Deployment 和 Service</strong>：</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get deployments</span><br><span class="line">kubectl get pods</span><br><span class="line">kubectl get svc nginx-service</span><br></pre></td></tr></table></figure>

<p>通过这些步骤，你可以在 Kubernetes 集群中创建并管理服务，以确保应用程序能够被正确访问。</p>
<h3 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h3><p>在你的 Kubernetes Deployment YAML 文件中，有三处与标签（labels）有关的配置。每一处标签的作用和含义如下：</p>
<h4 id="eployment-元数据中的标签"><a href="#eployment-元数据中的标签" class="headerlink" title="eployment 元数据中的标签"></a>eployment 元数据中的标签</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-dep</span></span><br></pre></td></tr></table></figure>

<h5 id="作用与含义："><a href="#作用与含义：" class="headerlink" title="作用与含义："></a>作用与含义：</h5><ul>
<li><strong>作用</strong>：为 Deployment 本身添加标签。</li>
<li><strong>含义</strong>：这些标签可以用于标识和查询 Deployment 资源。例如，你可以使用 <code>kubectl get deployments -l app=my-dep</code> 来查询所有带有 <code>app: my-dep</code> 标签的 Deployment。</li>
</ul>
<h4 id="Pod-模板元数据中的标签"><a href="#Pod-模板元数据中的标签" class="headerlink" title="Pod 模板元数据中的标签"></a>Pod 模板元数据中的标签</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">template:</span></span><br><span class="line">  <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">my-dep</span></span><br></pre></td></tr></table></figure>

<h5 id="作用与含义：-1"><a href="#作用与含义：-1" class="headerlink" title="作用与含义："></a>作用与含义：</h5><ul>
<li><strong>作用</strong>：为由这个 Deployment 创建的 Pod 添加标签。</li>
<li><strong>含义</strong>：这些标签用于标识和查询 Pod 资源，并且与 Deployment 的选择器（selector）相匹配。确保这些 Pod 会被 Deployment 选择器识别和管理。例如，你可以使用 <code>kubectl get pods -l app=my-dep</code> 来查询所有带有 <code>app: my-dep</code> 标签的 Pod。</li>
</ul>
<h4 id="Deployment-选择器中的标签匹配"><a href="#Deployment-选择器中的标签匹配" class="headerlink" title="Deployment 选择器中的标签匹配"></a>Deployment 选择器中的标签匹配</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">selector:</span></span><br><span class="line">  <span class="attr">matchLabels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-dep</span></span><br></pre></td></tr></table></figure>

<h5 id="作用与含义：-2"><a href="#作用与含义：-2" class="headerlink" title="作用与含义："></a>作用与含义：</h5><ul>
<li><strong>作用</strong>：定义 Deployment 如何选择和匹配 Pod。</li>
<li><strong>含义</strong>：<code>matchLabels</code> 是一个键值对的集合，Deployment 会选择那些标签中包含 <code>app: my-dep</code> 的 Pod。这个选择器确保 Deployment 只管理那些具有匹配标签的 Pod。</li>
</ul>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ul>
<li><strong>Deployment 元数据中的标签</strong>：用于标识和查询 Deployment 资源。</li>
<li><strong>Pod 模板元数据中的标签</strong>：用于标识和查询由 Deployment 创建的 Pod，并确保这些 Pod 能被 Deployment 选择器匹配到。</li>
<li><strong>Deployment 选择器中的标签匹配</strong>：定义 Deployment 如何选择和管理 Pod，确保只管理那些具有特定标签的 Pod。</li>
</ul>
<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><h3 id="tree"><a href="#tree" class="headerlink" title="tree"></a>tree</h3><p><code>tree</code>命令是一个用于以树状结构显示文件和目录的命令行工具。它在Linux和Unix系统中非常常用，用于直观地展示目录结构。以下是<code>tree</code>命令的详细用法和一些常用选项：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install tree -y</span><br></pre></td></tr></table></figure>

<h4 id="基本用法："><a href="#基本用法：" class="headerlink" title="基本用法："></a>基本用法：</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tree</span><br></pre></td></tr></table></figure>

<p>默认情况下，<code>tree</code>命令会在当前目录下递归显示所有的子目录和文件。</p>
<h4 id="常用选项："><a href="#常用选项：" class="headerlink" title="常用选项："></a>常用选项：</h4><ul>
<li><p><strong><code>-L</code> 指定递归的深度</strong>：例如，<code>tree -L 2</code>将只显示当前目录下的直接子目录和文件，不再递归显示子目录的内容。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tree -L 2</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>-d</code> 只显示目录</strong>：该选项只会显示目录，而不显示文件。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tree -d</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>-a</code> 显示所有文件和目录，包括隐藏文件</strong>：默认情况下，<code>tree</code>命令不显示以点开头的隐藏文件，使用<code>-a</code>选项可以显示所有文件和目录。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tree -a</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>-I</code> 排除特定模式的文件或目录</strong>：例如，<code>tree -I &quot;*.log&quot;</code>将排除所有扩展名为 <code>.log</code> 的文件。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tree -I <span class="string">&quot;*.log&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>-p</code> 显示权限模式</strong>：该选项会在每个文件和目录的名称前面显示权限模式。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tree -p</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>-h</code> 人类可读的文件大小</strong>：该选项会以人类可读的格式（例如 KB、MB）显示文件大小。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tree -h</span><br></pre></td></tr></table></figure></li>
</ul>
<p>这些选项可以根据你的需求组合使用，以便获取你想要的目录结构显示。<code>tree</code> 命令非常适合用于快速查看和分析目录结构，尤其是当你需要了解大型项目或者复杂目录结构时。</p>
<h3 id="firewall"><a href="#firewall" class="headerlink" title="firewall"></a>firewall</h3><p>在 CentOS 上，你可以使用 <code>firewalld</code> 来配置防火墙规则。以下是一些常见的防火墙操作命令：</p>
<ol>
<li><p><strong>检查防火墙状态</strong>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --state</span><br></pre></td></tr></table></figure>

<p>这个命令会告诉你防火墙是启用（<code>running</code>）还是禁用（<code>not running</code>）。</p>
</li>
<li><p><strong>启用&#x2F;禁用防火墙</strong>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启用防火墙</span></span><br><span class="line">sudo systemctl start firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止防火墙</span></span><br><span class="line">sudo systemctl stop firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置防火墙开机启动</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁止防火墙开机启动</span></span><br><span class="line">sudo systemctl <span class="built_in">disable</span> firewalld</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>添加&#x2F;删除防火墙规则</strong>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加规则（例如，打开端口 80）</span></span><br><span class="line">sudo firewall-cmd --zone=public --add-port=80/tcp --permanent</span><br><span class="line">sudo firewall-cmd --reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除规则</span></span><br><span class="line">sudo firewall-cmd --zone=public --remove-port=80/tcp --permanent</span><br><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<p>在这里，<code>--zone</code> 参数指定了规则应该应用在哪个区域（例如，<code>public</code>、<code>internal</code>、<code>trusted</code> 等）。<code>--add-port</code> 用于添加端口规则，<code>--permanent</code> 表示这个规则是持久的，会在防火墙重启后保留。</p>
</li>
<li><p><strong>查看所有开放的端口</strong>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --zone=public --list-ports</span><br></pre></td></tr></table></figure>

<p>这个命令会列出当前区域（public）开放的所有端口。</p>
</li>
</ol>
<h3 id="查看所有环境变量"><a href="#查看所有环境变量" class="headerlink" title="查看所有环境变量"></a>查看所有环境变量</h3><p>用 <code>printenv</code> 命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printenv</span></span><br></pre></td></tr></table></figure>

<p>该命令将列出所有环境变量及其值。</p>
<p>使用 <code>env</code> 命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">env</span></span><br></pre></td></tr></table></figure>

<p>这个命令也会列出所有环境变量及其值。</p>
<p>使用 <code>set</code> 命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span></span><br></pre></td></tr></table></figure>

<p><code>set</code>命令不仅列出所有环境变量，还列出所有 shell 变量</p>
<h3 id="CentOS-必备软件"><a href="#CentOS-必备软件" class="headerlink" title="CentOS 必备软件"></a>CentOS 必备软件</h3><ol>
<li><p><strong>文本编辑器</strong>：例如 Vim、Nano 或 Emacs，用于编辑配置文件和编写脚本。</p>
</li>
<li><p><strong>网络工具</strong>：例如 curl 和 wget 用于从网络上下载文件，net-tools 包含了一些网络工具如 ifconfig、netstat 等。</p>
</li>
<li><p><strong>系统监控工具</strong>：例如 htop 或 top，用于监视系统资源使用情况。</p>
</li>
<li><p><strong>版本控制工具</strong>：例如 Git 或 Subversion，用于管理代码版本。</p>
</li>
<li><p><strong>压缩&#x2F;解压工具</strong>：例如 gzip、tar 和 unzip，用于处理压缩文件。</p>
</li>
<li><p><strong>安全工具</strong>：例如 OpenSSH 客户端和服务器，用于远程登录和文件传输。</p>
</li>
</ol>
<p>您可以使用以下命令来安装这些软件包：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y vim nano emacs curl wget net-tools htop gzip tar unzip openssh-clients openssh-server</span><br></pre></td></tr></table></figure>

<h3 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h3><p>在 CentOS 7.9 中创建用户 <code>maysean</code>，并设置密码和赋予 root 权限，可以按照以下步骤操作：</p>
<ol>
<li><p><strong>创建用户并设置密码</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo useradd maysean</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;maysean:maysean&quot;</span> | sudo chpasswd</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>赋予 root 权限</strong>：<br>要让 <code>maysean</code> 用户拥有 root 权限，可以将其添加到 <code>wheel</code> 组（在 CentOS 中，<code>wheel</code> 组的用户可以使用 <code>sudo</code> 执行 root 权限的命令）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod -aG wheel maysean</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>验证 sudo 权限</strong>：<br>编辑 <code>/etc/sudoers</code> 文件，确保 <code>wheel</code> 组有执行 sudo 的权限。打开文件并检查以下行是否被注释掉（以 <code>#</code> 开头的行表示被注释，去掉 <code>#</code> 即可生效）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo visudo</span><br></pre></td></tr></table></figure>

<p>找到并确认以下行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%wheel  ALL=(ALL)       ALL</span><br></pre></td></tr></table></figure></li>
</ol>
<p>完成以上步骤后，<code>maysean</code> 用户将拥有 sudo 权限，可以执行 root 权限的操作。</p>
<p>这个错误是因为 Minikube 无法使用默认的 Docker 驱动程序启动，并提示多个原因。解决方案如下：</p>
<h3 id="2-赋予用户-Docker-权限"><a href="#2-赋予用户-Docker-权限" class="headerlink" title="2. 赋予用户 Docker 权限"></a>2. 赋予用户 Docker 权限</h3><p>错误提示了 <code>permission denied</code>，说明当前用户没有访问 Docker 的权限。解决方法是将当前用户添加到 Docker 组，然后重新登录使权限生效：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod -aG docker <span class="variable">$USER</span></span><br><span class="line">newgrp docker</span><br></pre></td></tr></table></figure>

<p>也可以直接注销并重新登录系统来使更改生效。</p>
<h3 id="3-验证-Docker-权限"><a href="#3-验证-Docker-权限" class="headerlink" title="3. 验证 Docker 权限"></a>3. 验证 Docker 权限</h3><p>重新验证是否有权限访问 Docker：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker info</span><br></pre></td></tr></table></figure>

<p>如果命令正常返回 Docker 信息，则表示权限设置成功。</p>
<p>可以通过以下步骤，使用 <code>root</code> 用户将一个文件复制到 <code>/home/maysean</code> 目录，并赋予 <code>maysean</code> 用户对该文件的所有权限。</p>
<p>假设要复制的文件路径为 <code>./proxy_toggle.sh</code>：</p>
<ol>
<li><p><strong>复制文件到目标用户目录</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">cp</span> ./proxy_toggle.sh /home/maysean/</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>更改文件所有权</strong>：<br>使用 <code>chown</code> 将文件的所有者更改为 <code>maysean</code>，同时更改用户组：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chown</span> maysean:maysean /home/maysean/proxy_toggle.sh</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>设置文件权限</strong>：<br>如果需要赋予 <code>maysean</code> 用户对该文件的所有权限（读、写、执行），可以设置权限为 <code>700</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chmod</span> 700 /home/maysean/proxy_toggle.sh</span><br></pre></td></tr></table></figure></li>
</ol>
<p>这样，<code>maysean</code> 用户将拥有 <code>/home/maysean/proxy_toggle.sh</code> 文件的完整权限。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://maysean.github.io">梅兮昂</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://maysean.github.io/dev-env-build/">https://maysean.github.io/dev-env-build/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://maysean.github.io" target="_blank">MaySean's Blog</a>！</span></div></div><div class="tag_share"><div class="post_share"><div class="social-share" data-image="/img/avatar.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.png" target="_blank"><img class="post-qr-code-img" src="/img/wechat.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.png" target="_blank"><img class="post-qr-code-img" src="/img/alipay.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/linux-install-python/" title=""><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info"></div></div></a></div><div class="next-post pull-right"><a href="/dockerfile/" title="一文搞懂 Dockerfile"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">一文搞懂 Dockerfile</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">梅兮昂</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">30</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/maysean"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.</span> <span class="toc-text">开发环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-docker-%E6%90%AD%E5%BB%BA"><span class="toc-number">1.1.</span> <span class="toc-text">基于 docker 搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#network"><span class="toc-number">1.1.1.</span> <span class="toc-text">network</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nacos"><span class="toc-number">1.1.2.</span> <span class="toc-text">nacos</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mysql-8-0-23"><span class="toc-number">1.1.3.</span> <span class="toc-text">mysql 8.0.23</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#seata-1-7-0"><span class="toc-number">1.1.4.</span> <span class="toc-text">seata 1.7.0</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sentinel-1-8-0"><span class="toc-number">1.1.5.</span> <span class="toc-text">sentinel 1.8.0</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redis-6-0"><span class="toc-number">1.1.6.</span> <span class="toc-text">redis 6.0</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#elasticsearch-7-6-2"><span class="toc-number">1.1.7.</span> <span class="toc-text">elasticsearch 7.6.2</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#elasticSearch-%E5%AF%B9%E8%B1%A1%E6%98%A0%E5%B0%84"><span class="toc-number">1.1.7.1.</span> <span class="toc-text">elasticSearch 对象映射</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Field"><span class="toc-number">1.1.7.2.</span> <span class="toc-text">@Field</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ik-%E5%88%86%E8%AF%8D%E5%99%A8-7-6-2"><span class="toc-number">1.1.8.</span> <span class="toc-text">ik 分词器 7.6.2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kibana-7-6-2"><span class="toc-number">1.1.9.</span> <span class="toc-text">kibana 7.6.2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#minio"><span class="toc-number">1.1.10.</span> <span class="toc-text">minio</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GCC"><span class="toc-number">1.1.11.</span> <span class="toc-text">GCC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nginx"><span class="toc-number">1.1.12.</span> <span class="toc-text">nginx</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E7%BC%96%E8%BE%91%E5%99%A8%EF%BC%88%E5%A6%82%E6%9E%9C%E6%9C%AA%E5%AE%89%E8%A3%85%EF%BC%89"><span class="toc-number">1.1.12.1.</span> <span class="toc-text">安装编辑器（如果未安装）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#xxljob"><span class="toc-number">1.1.13.</span> <span class="toc-text">xxljob</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rabbitmq"><span class="toc-number">1.1.14.</span> <span class="toc-text">rabbitmq</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%92%E4%BB%B6%E6%8C%82%E8%BD%BD"><span class="toc-number">1.1.15.</span> <span class="toc-text">插件挂载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kafka"><span class="toc-number">1.1.16.</span> <span class="toc-text">kafka</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MongoDB"><span class="toc-number">1.1.17.</span> <span class="toc-text">MongoDB</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%94%9F%E6%96%B9%E5%BC%8F%E6%90%AD%E5%BB%BA"><span class="toc-number">1.2.</span> <span class="toc-text">原生方式搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#jdk"><span class="toc-number">1.2.1.</span> <span class="toc-text">jdk</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#openjdk"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">openjdk</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#oraclejdk"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">oraclejdk</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#zookeeper"><span class="toc-number">1.2.2.</span> <span class="toc-text">zookeeper</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E6%9C%BA%E9%83%A8%E7%BD%B2"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">单机部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">集群部署</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kafka-1"><span class="toc-number">1.2.3.</span> <span class="toc-text">kafka</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E6%9C%BA%E9%83%A8%E7%BD%B2-1"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">单机部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2-1"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">集群部署</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#minikube"><span class="toc-number">1.2.4.</span> <span class="toc-text">minikube</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kubernetes%EF%BC%88%E5%8D%95%E6%9C%BA%E7%89%88%EF%BC%89"><span class="toc-number">1.2.5.</span> <span class="toc-text">kubernetes（单机版）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%88%E6%9C%AC%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.2.5.1.</span> <span class="toc-text">版本介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%8E%AF%E5%A2%83"><span class="toc-number">1.2.5.2.</span> <span class="toc-text">虚拟机环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E8%BF%87%E7%A8%8B"><span class="toc-number">1.2.5.3.</span> <span class="toc-text">部署过程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kubernetes-%E9%9B%86%E7%BE%A4"><span class="toc-number">1.2.6.</span> <span class="toc-text">kubernetes 集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%88%E6%9C%AC%E4%BB%8B%E7%BB%8D-1"><span class="toc-number">1.2.6.1.</span> <span class="toc-text">版本介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%8E%AF%E5%A2%83-1"><span class="toc-number">1.2.6.2.</span> <span class="toc-text">虚拟机环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E8%BF%87%E7%A8%8B-1"><span class="toc-number">1.2.6.3.</span> <span class="toc-text">部署过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A1%A5%E5%85%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">1.2.6.4.</span> <span class="toc-text">补全命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-kubectl-%E5%91%BD%E4%BB%A4"><span class="toc-number">1.2.6.5.</span> <span class="toc-text">配置 kubectl 命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E8%A7%86%E5%8C%96%E7%95%8C%E9%9D%A2"><span class="toc-number">1.2.6.6.</span> <span class="toc-text">可视化界面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Ingress"><span class="toc-number">1.2.6.7.</span> <span class="toc-text">Ingress</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#k8s-%E5%AD%A6%E4%B9%A0%E5%BF%83%E5%BE%97"><span class="toc-number">1.2.7.</span> <span class="toc-text">k8s 学习心得</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E5%90%8D%E7%A7%B0"><span class="toc-number">1.2.7.1.</span> <span class="toc-text">资源名称</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="toc-number">1.2.7.2.</span> <span class="toc-text">命名空间</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E5%91%BD%E5%90%8D%E7%BA%A6%E5%AE%9A"><span class="toc-number">1.2.7.3.</span> <span class="toc-text">常见命名约定</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.2.7.4.</span> <span class="toc-text">示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4-1"><span class="toc-number">1.2.7.5.</span> <span class="toc-text">命名空间</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Pod-%E5%AE%9A%E4%B9%89"><span class="toc-number">1.2.7.6.</span> <span class="toc-text">Pod 定义</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0-Kubernetes-%E8%B5%84%E6%BA%90%E4%B8%AD%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F"><span class="toc-number">1.2.8.</span> <span class="toc-text">更新 Kubernetes 资源中容器镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="toc-number">1.2.8.1.</span> <span class="toc-text">基本用法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-1"><span class="toc-number">1.2.8.2.</span> <span class="toc-text">示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E4%B8%AA%E5%AE%B9%E5%99%A8"><span class="toc-number">1.2.8.3.</span> <span class="toc-text">多个容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9E%E6%BB%9A"><span class="toc-number">1.2.8.4.</span> <span class="toc-text">回滚</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E6%9B%B4%E6%96%B0%E7%8A%B6%E6%80%81"><span class="toc-number">1.2.8.5.</span> <span class="toc-text">检查更新状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-YAML"><span class="toc-number">1.2.8.6.</span> <span class="toc-text">示例 YAML</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SVC"><span class="toc-number">1.2.9.</span> <span class="toc-text">SVC</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-YAML-%E6%96%87%E4%BB%B6"><span class="toc-number">1.2.9.1.</span> <span class="toc-text">示例 YAML 文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.2.9.2.</span> <span class="toc-text">创建服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LoadBalancer-%E7%B1%BB%E5%9E%8B%E7%9A%84%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.2.9.3.</span> <span class="toc-text">LoadBalancer 类型的服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.2.9.4.</span> <span class="toc-text">完整示例</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Deployment-YAML-%E6%96%87%E4%BB%B6"><span class="toc-number">1.2.9.4.1.</span> <span class="toc-text">Deployment YAML 文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Service-YAML-%E6%96%87%E4%BB%B6"><span class="toc-number">1.2.9.4.2.</span> <span class="toc-text">Service YAML 文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BA%94%E7%94%A8-YAML-%E6%96%87%E4%BB%B6"><span class="toc-number">1.2.9.4.3.</span> <span class="toc-text">应用 YAML 文件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%87%E7%AD%BE"><span class="toc-number">1.2.10.</span> <span class="toc-text">标签</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#eployment-%E5%85%83%E6%95%B0%E6%8D%AE%E4%B8%AD%E7%9A%84%E6%A0%87%E7%AD%BE"><span class="toc-number">1.2.10.1.</span> <span class="toc-text">eployment 元数据中的标签</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%90%AB%E4%B9%89%EF%BC%9A"><span class="toc-number">1.2.10.1.1.</span> <span class="toc-text">作用与含义：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Pod-%E6%A8%A1%E6%9D%BF%E5%85%83%E6%95%B0%E6%8D%AE%E4%B8%AD%E7%9A%84%E6%A0%87%E7%AD%BE"><span class="toc-number">1.2.10.2.</span> <span class="toc-text">Pod 模板元数据中的标签</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%90%AB%E4%B9%89%EF%BC%9A-1"><span class="toc-number">1.2.10.2.1.</span> <span class="toc-text">作用与含义：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Deployment-%E9%80%89%E6%8B%A9%E5%99%A8%E4%B8%AD%E7%9A%84%E6%A0%87%E7%AD%BE%E5%8C%B9%E9%85%8D"><span class="toc-number">1.2.10.3.</span> <span class="toc-text">Deployment 选择器中的标签匹配</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%90%AB%E4%B9%89%EF%BC%9A-2"><span class="toc-number">1.2.10.3.1.</span> <span class="toc-text">作用与含义：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.2.10.4.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%E5%BD%95"><span class="toc-number">1.3.</span> <span class="toc-text">附录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#tree"><span class="toc-number">1.3.1.</span> <span class="toc-text">tree</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95%EF%BC%9A"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">基本用法：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E9%80%89%E9%A1%B9%EF%BC%9A"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">常用选项：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#firewall"><span class="toc-number">1.3.2.</span> <span class="toc-text">firewall</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%89%80%E6%9C%89%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">1.3.3.</span> <span class="toc-text">查看所有环境变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CentOS-%E5%BF%85%E5%A4%87%E8%BD%AF%E4%BB%B6"><span class="toc-number">1.3.4.</span> <span class="toc-text">CentOS 必备软件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7"><span class="toc-number">1.3.5.</span> <span class="toc-text">创建用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%B5%8B%E4%BA%88%E7%94%A8%E6%88%B7-Docker-%E6%9D%83%E9%99%90"><span class="toc-number">1.3.6.</span> <span class="toc-text">2. 赋予用户 Docker 权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E9%AA%8C%E8%AF%81-Docker-%E6%9D%83%E9%99%90"><span class="toc-number">1.3.7.</span> <span class="toc-text">3. 验证 Docker 权限</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/linux-install-python/" title="无题">无题</a><time datetime="2024-09-18T01:41:40.472Z" title="发表于 2024-09-18 09:41:40">2024-09-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/dev-env-build/" title="开发环境搭建">开发环境搭建</a><time datetime="2024-08-04T02:47:30.000Z" title="发表于 2024-08-04 10:47:30">2024-08-04</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/dockerfile/" title="一文搞懂 Dockerfile">一文搞懂 Dockerfile</a><time datetime="2024-08-04T02:46:30.000Z" title="发表于 2024-08-04 10:46:30">2024-08-04</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/docker-use-summary/" title="Docker 使用小结">Docker 使用小结</a><time datetime="2024-07-31T02:17:30.000Z" title="发表于 2024-07-31 10:17:30">2024-07-31</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/devops-gitlab-cicd/" title="devops 之 gitlab 的 cicd 流水线">devops 之 gitlab 的 cicd 流水线</a><time datetime="2024-07-01T01:43:39.000Z" title="发表于 2024-07-01 09:43:39">2024-07-01</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/bg.png')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By 梅兮昂</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a href="https://beian.miit.gov.cn/" target="_blank">鄂ICP备2023017152号-1</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="富强,民主,文明,和谐,自由,平等,公正,法治,爱国,敬业,诚信,友善" data-fontsize="15px" data-random="false" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>